# 基礎データ管理ページ実装状況

**最終更新**: 2026-02-04

## 📊 実装状況サマリー

| 機能 | UI | バックエンド | 実装状態 |
|------|----|-----------|---------|
| ページ表示 | ✅ | ✅ | 完了 |
| 登録済みデータ一覧表示 | ✅ | ✅ | 完了 |
| CSV一括取込 | ✅ | ✅ | 完了 |
| 新規データ入力（手動） | ⚠️ | ✅ | **未実装**（ボタンのみ） |
| データ編集 | ❌ | ✅ | **未実装** |
| データ削除 | ❌ | ✅ | **未実装** |

---

## 1. 実装済み機能

### ✅ 1.1 ページ表示
- **UI**: 完全実装
  - ページヘッダー「基礎データ管理」
  - 説明文「月次データの入力・編集、CSVインポート」
- **レイアウト**: 2カラム（月次データ入力 / CSV一括取込）

### ✅ 1.2 登録済みデータ一覧表示
- **UI**: テーブル実装済み
  - カラム: 年月、総売上、営業利益、総患者数、データソース、操作
- **バックエンド**: `GET /api/monthly-data?clinic_id={id}` - 実装済み
- **動作**: 正常にデータを取得・表示（現在は「データがありません」）

### ✅ 1.3 CSV一括取込
- **UI**: 「CSVファイル選択」ボタン - 実装済み
- **バックエンド**: `POST /api/monthly-data/import-csv` - 実装済み
- **処理フロー**:
  1. ファイル選択ダイアログ表示
  2. PapaParse（クライアント側）でCSVパース
  3. バックエンドAPI呼び出し
  4. 成功/失敗件数を表示
  5. データ一覧を自動更新

---

## 2. 未実装機能

### ⚠️ 2.1 新規データ入力（手動入力）

**現状**:
- **UI**: 「+ 新規データ入力」ボタンのみ表示
- **動作**: クリック時にエラートースト「月次データ入力機能は開発中です」
- **コード**: `handleNewDataEntry()` - TODO（77-81行目）

**必要な実装**:
1. **入力ダイアログ作成**
   - 年月選択（DatePicker）
   - 全フィールド入力フォーム（売上、コスト、患者数等）
   - バリデーション

2. **API連携**
   - バックエンド: `POST /api/monthly-data` - **実装済み**
   - フロントエンド: `monthlyDataService.createMonthlyData()` - **実装済み**
   - ダイアログからAPI呼び出しを接続

3. **工数**: 1-2日

**回避策**（現在）:
- CSV一括取込機能を使用してデータ登録
- 手動入力は運用開始後に実装

### ❌ 2.2 データ編集機能

**現状**: 完全未実装

**必要な実装**:
1. テーブルに「編集」ボタン追加
2. 編集ダイアログ（新規入力と同様のフォーム）
3. `PUT /api/monthly-data/{id}` API呼び出し（実装済み）

**工数**: 1日

### ❌ 2.3 データ削除機能

**現状**: 完全未実装

**必要な実装**:
1. テーブルに「削除」ボタン追加
2. 確認ダイアログ
3. `DELETE /api/monthly-data/{id}` API呼び出し（実装済み）

**工数**: 0.5日

---

## 3. チェックリスト検証結果

### ❌ 3.2.1 データ入力フォーム表示
- **期待**: 月次データ入力フォームが表示される
- **実際**: ボタンのみ、フォームなし（TODO）
- **判定**: **未実装**

### ❌ 3.2.2 月選択
- **期待**: 年月を選択できる
- **実際**: フォーム自体が未実装のため選択不可
- **判定**: **未実装**

### ✅ 3.2.3 データ表示
- **期待**: 登録済みデータが一覧表示される
- **実際**: テーブルは実装済み、現在は「データがありません」と表示
- **判定**: **正常**（データがないだけ）

### ✅ 3.2.4 CSV取込
- **期待**: CSVファイルをアップロードできる
- **実際**: 実装済み、動作正常
- **判定**: **実装済み**

---

## 4. バックエンドAPI実装状況

| エンドポイント | メソッド | 状態 | 備考 |
|-------------|---------|------|------|
| `/api/monthly-data` | GET | ✅ 実装済み | clinic_idで絞り込み |
| `/api/monthly-data` | POST | ✅ 実装済み | 新規データ作成 |
| `/api/monthly-data/{id}` | PUT | ✅ 実装済み | データ更新 |
| `/api/monthly-data/{id}` | DELETE | ✅ 実装済み | データ削除 |
| `/api/monthly-data/import-csv` | POST | ✅ 実装済み | CSV一括取込 |

**結論**: バックエンドAPIは全て実装済み。フロントエンドのUI接続のみ未実装。

---

## 5. 推奨アクション

### 🔴 優先度: 高（クライアントテスト前に必要）

**新規データ入力機能の実装**
- **理由**: CSV取込だけでは不便。1件ずつ入力したい場合がある
- **工数**: 1-2日
- **実装範囲**:
  1. 入力ダイアログ作成
  2. 年月選択（DatePicker）
  3. 全フィールド入力フォーム
  4. バリデーション
  5. 既存API（POST /api/monthly-data）への接続

### 🟡 優先度: 中（運用開始後に必要）

1. **データ編集機能** - 工数: 1日
2. **データ削除機能** - 工数: 0.5日

### 🟢 優先度: 低（将来的な改善）

- データ一括編集
- データエクスポート（CSV出力）

---

## 6. 暫定対応（現在）

### CSVフォーマット例

クライアントがCSV取込を使用する場合のフォーマット:

```csv
year_month,total_revenue,insurance_revenue,self_pay_revenue,new_patients,returning_patients,total_patients,personnel_cost,material_cost,fixed_cost,other_cost,chair_count,operating_days,self_pay_rate,unit_utilization
2025-11,8500000,6000000,2500000,35,385,420,3000000,1500000,1200000,600000,6,22,29.4,100
```

### 必須カラム
- `year_month`: YYYY-MM形式
- `total_revenue`: 総売上（円）
- `insurance_revenue`: 保険売上（円）
- `self_pay_revenue`: 自費売上（円）
- `new_patients`: 新患数
- `returning_patients`: 既存患者数
- `total_patients`: 総患者数
- `personnel_cost`: 人件費（円）
- `material_cost`: 材料費（円）
- `fixed_cost`: 固定費（円）
- `other_cost`: その他費用（円）
- `chair_count`: ユニット数
- `operating_days`: 営業日数
- `self_pay_rate`: 自費率（%）
- `unit_utilization`: 稼働率（%）

---

## 結論

**現状**: 基礎データ管理ページの主要機能（CSV一括取込、データ一覧表示）は実装済み。手動入力フォームのみ未実装。

**クライアントテストへの影響**:
- CSV取込で運用可能だが、手動入力機能がないため不便
- クライアントテスト前に「新規データ入力」機能の実装を推奨

**実装優先度**: 🔴 高（1-2日の工数で完成）
