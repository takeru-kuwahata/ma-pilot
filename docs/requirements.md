# MA-Pilot - 要件定義書

## 要件定義の作成原則

- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標

開業歯科医院がPILOT経由で経営数値を入力・自動取得し、リアルタイムな可視化・目標達成シミュレーション・戦略レポート生成を実現。データ駆動の経営判断と有料プランへの自然な転換を促す。

### 1.2 成功指標

#### 定量的指標

1. 導入医院数: リリース後6ヶ月以内に30医院以上が利用開始
2. データ入力完了率: 初回利用時に70%以上のユーザーが必須項目（売上、固定費、ユニット数等）を入力完了
3. PILOT連携成功率: 95%以上のユーザーでPILOTからのCSVデータ取込が正常動作
4. シミュレーション実行率: 月1回以上シミュレーション機能を使用するユーザーが60%以上
5. レポートDL率: 月1回以上レポートをダウンロード（PDF/CSV）するユーザーが50%以上

#### 定性的指標

1. 意思決定の自信: 「このツールのおかげで経営判断に自信が持てた」と80%以上が回答
2. 入力の手軽さ: 「PILOTデータが自動で入り、追加入力も迷わずできた」と評価
3. シミュレーションの実用性: 「提案された戦略（ユニット増設、採用計画等）が具体的で実践しやすい」と評価
4. レポートの価値: 「生成されたレポートを経営会議や銀行提出に活用できた」と評価

---

## 2. システム全体像

### 2.1 主要機能一覧

- **認証・権限管理**: メール+パスワード認証、4段階の権限管理（システム管理者、医院オーナー、医院編集者、医院閲覧者）
- **経営データ管理**: 売上、固定費、患者数、スタッフ情報等の入力・編集・一括取込
- **PILOT連携**: CSVデータ取込によるPILOT顧客データ活用
- **診療圏分析**: 人口統計・商圏データ取得、競合医院検索、地図表示
- **経営シミュレーション**: 目標逆算、戦略提案、複数シナリオ比較
- **レポート生成**: PDF/CSV形式での経営レポート自動生成
- **管理機能**: 全医院管理、アカウント管理、システム設定

### 2.2 ユーザーロールと権限

#### ゲスト

- ログイン画面のみアクセス可能

#### 医院閲覧者

- 自医院データの閲覧
- レポートダウンロード
- シミュレーション結果閲覧

#### 医院編集者

- 医院閲覧者の権限 +
- 自医院データの入力・編集
- シミュレーション実行
- PILOTデータ取込

#### 医院オーナー

- 医院編集者の権限 +
- 自医院データの削除
- スタッフアカウント管理（招待、権限変更、削除）
- 医院基本情報編集

#### システム管理者

- 全医院データの閲覧・分析
- 医院アカウント管理（有効化・無効化）
- 全医院の集計データ閲覧
- システム設定管理
- サポート対応（医院データの閲覧・修正支援）

### 2.3 認証・認可要件

#### 認証方式

- メール + パスワード認証（Supabase Auth）
- パスワードリセット機能
- 招待メール機能（オーナーが新規スタッフを招待）

#### セキュリティレベル

- 扱うデータ: 医院の経営数値（売上、利益、患者数等）
- セキュリティ分類: 機密情報（社外秘相当）
- 対応策:
  - SSL/TLS通信必須
  - Supabase Row Level Security（RLS）で医院単位のデータ分離
  - パスワードポリシー（8文字以上、英数字混在推奨）
  - セッション管理（一定期間で自動ログアウト）

#### 管理機能

- 必要性: 必須
- 具体的な機能:
  - 医院アカウント一覧・詳細閲覧
  - 医院の有効化・無効化（契約終了時）
  - 全医院の集計データ閲覧（ベンチマーク分析用）
  - サポート対応（医院データの閲覧・修正支援）
  - システム設定（通知メール設定、マスタデータ管理等）

---

## 3. ページ詳細仕様

### 3.1 P-001: ログイン/アカウント作成

#### 目的
システムへの安全なアクセスを提供し、医院スタッフが自身のアカウントで経営データを管理できるようにする。

#### 主要機能

- メールアドレス + パスワードでのログイン
- 新規アカウント作成（招待経由）
- パスワードリセット（メール送信）
- 初回ログイン時のパスワード設定

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 認証 | ログイン | メールアドレス、パスワード | セッショントークン、ユーザー情報 |
| 作成 | 招待経由のアカウント作成 | 招待トークン、パスワード設定 | アカウント作成完了、自動ログイン |
| 更新 | パスワードリセット | メールアドレス | パスワードリセットメール送信 |

#### 処理フロー

1. ユーザーがメールアドレス・パスワードを入力
2. Supabase Authで認証処理
3. 認証成功時、ロールに応じたダッシュボードにリダイレクト
4. 認証失敗時、エラーメッセージ表示

#### データ構造（概念）

```yaml
User:
  識別子: UUID（Supabase Auth）
  基本情報:
    - email（必須）
    - password_hash（必須）
    - role（必須: system_admin, clinic_owner, clinic_editor, clinic_viewer）
    - clinic_id（医院ユーザーの場合必須）
  メタ情報:
    - created_at
    - last_login_at
  関連:
    - Clinic（多対1: 医院ユーザーの場合）
```

---

### 3.2 P-002: 経営ダッシュボード

#### 目的
医院の経営状況を一目で把握し、主要KPI・推移グラフ・アラートを通じてデータ駆動の意思決定を支援する。

#### 主要機能

- 主要KPI表示（売上、営業利益、粗利率、患者数、ユニット稼働率、自費率、リコール率等）
- 月次推移グラフ（売上・利益推移、患者数推移、稼働率推移）
- 前月比・前年比比較
- アラート通知（目標未達、異常値検知）
- クイックアクション（データ入力、シミュレーション実行へのリンク）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | ダッシュボードデータ取得 | clinic_id、表示期間 | KPI集計データ、グラフデータ |
| 取得 | アラート一覧取得 | clinic_id | アラート情報リスト |

#### 処理フロー

1. ログイン後、ユーザーのロールと所属医院を判定
2. 医院の最新経営データを取得
3. KPI自動計算（営業利益、粗利率、ユニット稼働率等）
4. グラフデータ生成（月次推移、比較データ）
5. アラート判定（目標未達、異常値）
6. ダッシュボード表示

#### データ構造（概念）

```yaml
DashboardKPI:
  識別子: 動的生成（clinic_id + 期間）
  基本情報:
    - 売上（当月・前月・前年同月）
    - 営業利益（当月・前月・前年同月）
    - 粗利率（自動計算）
    - 患者数（新患・既患・合計）
    - ユニット稼働率（自動計算）
    - 自費率（自動計算）
    - リコール率（PILOT連携データ）
  メタ情報:
    - 計算日時
    - データソース（手入力/PILOT連携）
  関連:
    - MonthlyData（複数の月次データから集計）
```

---

### 3.3 P-003: 基礎データ管理

#### 目的
医院の経営データを簡単に入力・編集・取込し、経営分析の基盤を構築する。

#### 主要機能

- 月次データ入力フォーム（売上、固定費、変動費、患者数、スタッフ情報等）
- PILOTデータ取込（CSV手動アップロード）
- 立地情報入力（住所、診療圏範囲設定）
- データ編集・削除
- 一括インポート機能（CSV/Excel）
- データバリデーション（必須項目チェック、数値範囲チェック）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | 月次データ入力 | clinic_id、年月、売上、固定費、患者数等 | データ保存完了、ダッシュボード更新 |
| 取得 | 既存データ取得 | clinic_id、年月 | 月次データ |
| 更新 | データ編集 | データID、更新内容 | 更新完了 |
| 削除 | データ削除 | データID | 削除完了 |
| 作成 | CSV一括取込 | CSVファイル | 取込結果（成功件数、エラー件数） |

#### 処理フロー

1. ユーザーが入力フォームまたはCSVアップロードを選択
2. 手入力の場合: フォームに入力、バリデーション実行、保存
3. CSV取込の場合: ファイルアップロード、パース、バリデーション、一括保存
4. PILOTデータの場合: CSV形式チェック、新患数・リコール率等の自動抽出
5. 保存成功時、ダッシュボードに反映

#### データ構造（概念）

```yaml
MonthlyData:
  識別子: UUID
  基本情報:
    - clinic_id（必須）
    - year_month（必須、YYYY-MM-01形式）
    - 売上データ:
      - total_revenue（総売上）
      - insurance_revenue（保険売上）
      - self_pay_revenue（自費売上）
    - コストデータ:
      - fixed_costs（固定費）
      - variable_costs（変動費）
      - staff_costs（人件費）
    - 患者データ:
      - new_patients（新患数）
      - returning_patients（既患数）
      - total_patients（合計患者数）
    - 設備データ:
      - units_count（ユニット台数）
      - units_utilization（ユニット稼働率）
    - スタッフデータ:
      - full_time_staff（正社員数）
      - part_time_staff（パート数）
      - part_time_hours（パート勤務時間）
  メタ情報:
    - data_source（手入力/PILOT連携/一括取込）
    - created_at
    - updated_at
  関連:
    - Clinic（多対1）
```

---

### 3.4 P-004: 診療圏分析

#### 目的
医院周辺の市場環境（人口統計、競合医院）を把握し、外部環境を加味した戦略立案を支援する。

#### 主要機能

- 地図表示（医院位置、診療圏範囲表示）
- 人口統計表示（e-Stat API連携: 人口、年齢構成、世帯数）
- 商圏データ表示（RESAS API連携: 産業構造、人口動態）
- 競合医院検索（Google Maps Places API: 診療圏内の歯科医院検索）
- 商圏レポート生成（人口統計 + 競合情報の統合レポート）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 診療圏データ取得 | clinic_id、診療圏範囲（半径） | 人口統計、商圏データ |
| 取得 | 競合医院検索 | 医院住所、診療圏範囲 | 競合歯科医院リスト（名称、住所、評価等） |
| 作成 | 商圏レポート生成 | clinic_id | レポートPDF |

#### 処理フロー

1. 医院の住所を緯度経度に変換（Community Geocoder）
2. 診療圏範囲（例: 半径2km）を設定
3. e-Stat APIで該当エリアの小地域別人口統計を取得
4. RESAS APIで商圏データ（産業構造、人口動態）を取得
5. Google Maps Places APIで競合歯科医院を検索
6. 地図上に医院・診療圏・競合を表示
7. 統計データをグラフ・表形式で表示
8. 商圏レポート生成（PDF）

#### データ構造（概念）

```yaml
MarketAnalysis:
  識別子: UUID
  基本情報:
    - clinic_id（必須）
    - analysis_date（分析日）
    - location:
      - address（住所）
      - latitude（緯度）
      - longitude（経度）
      - radius_km（診療圏範囲）
    - 人口統計:
      - total_population（総人口）
      - age_distribution（年齢別人口）
      - household_count（世帯数）
    - 競合情報:
      - competitors_count（競合医院数）
      - competitors_list（競合医院リスト）
  メタ情報:
    - data_source（e-Stat、RESAS、Google Maps）
    - created_at
  関連:
    - Clinic（多対1）
```

---

### 3.5 P-005: 経営シミュレーション

#### 目的
目標売上・利益達成のための具体的な戦略（必要患者数、ユニット増設、採用計画等）を提案し、データ駆動の意思決定を支援する。

#### 主要機能

- 目標設定（目標売上、目標営業利益）
- 逆算シミュレーション（目標達成に必要な患者数、単価、稼働率）
- 戦略提案（ユニット増設、スタッフ採用、自費率向上等）
- 複数シナリオ比較（保守的・標準・積極的シナリオ）
- シミュレーション履歴管理（過去のシミュレーション結果保存）
- グラフ表示（現状 vs 目標達成後の比較）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | シミュレーション実行 | clinic_id、目標売上、目標利益、前提条件 | シミュレーション結果（必要患者数、戦略提案） |
| 取得 | シミュレーション履歴取得 | clinic_id | 過去のシミュレーション結果リスト |
| 取得 | シミュレーション詳細取得 | simulation_id | シミュレーション詳細データ |

#### 処理フロー

1. ユーザーが目標値（売上、利益）を入力
2. 前提条件設定（ユニット台数、スタッフ数、診療日数等）
3. バックエンドで逆算ロジック実行:
   - 目標達成に必要な月間患者数を算出
   - 現在のユニット稼働率から必要なユニット台数を計算
   - スタッフ1人あたり対応可能患者数から必要スタッフ数を計算
   - 自費率向上による利益インパクトを計算
4. 戦略提案の生成（例: 「ユニット1台追加で月間患者数+30人可能」）
5. 複数シナリオ（保守的・標準・積極的）の自動生成
6. 結果をグラフ・表で表示
7. シミュレーション結果をDBに保存

#### データ構造（概念）

```yaml
Simulation:
  識別子: UUID
  基本情報:
    - clinic_id（必須）
    - simulation_name（シミュレーション名）
    - 目標設定:
      - target_revenue（目標売上）
      - target_profit（目標営業利益）
    - 前提条件:
      - current_units（現在のユニット台数）
      - current_staff（現在のスタッフ数）
      - operating_days_per_month（月間営業日数）
      - avg_treatment_time（平均診療時間）
    - シミュレーション結果:
      - required_patients（必要患者数）
      - required_units（必要ユニット台数）
      - required_staff（必要スタッフ数）
      - recommended_self_pay_rate（推奨自費率）
    - 戦略提案:
      - strategy_list（戦略リスト）
  メタ情報:
    - created_at
  関連:
    - Clinic（多対1）
```

---

### 3.6 P-006: レポート生成・管理

#### 目的
経営レポートをPDF/CSV形式で自動生成し、銀行提出や経営会議での活用を可能にする。

#### 主要機能

- レポートテンプレート選択（月次レポート、年次レポート、シミュレーション結果レポート）
- 期間設定・項目カスタマイズ
- プレビュー表示
- PDF/CSVダウンロード
- 過去レポート一覧・再ダウンロード
- ブランディング対応（医院ロゴ、カラー設定）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | レポート生成 | clinic_id、テンプレート種類、期間、項目設定 | PDF/CSVファイル |
| 取得 | 過去レポート一覧 | clinic_id | レポート履歴リスト |
| 取得 | レポート再ダウンロード | report_id | PDF/CSVファイル |

#### 処理フロー

1. ユーザーがレポート種類・期間・項目を選択
2. プレビュー生成（HTML）
3. ユーザーが確認後、PDF/CSV生成を指示
4. バックエンドでデータ取得・集計
5. WeasyPrintでPDF生成（または CSV生成）
6. Supabase Storageに保存
7. ダウンロードリンクをユーザーに返却
8. レポート履歴に記録

#### データ構造（概念）

```yaml
Report:
  識別子: UUID
  基本情報:
    - clinic_id（必須）
    - report_type（月次/年次/シミュレーション）
    - period_start（対象期間開始）
    - period_end（対象期間終了）
    - file_format（PDF/CSV）
    - file_url（Supabase Storage URL）
  メタ情報:
    - generated_at
    - file_size
  関連:
    - Clinic（多対1）
```

---

### 3.7 P-007: 医院設定・スタッフ管理

#### 目的
医院基本情報とアクセス権限を管理し、複数スタッフでの役割分担による効率的な運用を実現する。

#### 主要機能

- 医院基本情報編集（名称、連絡先、住所、ロゴアップロード、ブランドカラー設定）
- スタッフアカウント管理（招待、権限変更、削除）
- 通知設定（メール通知、アラート設定）
- 個人設定（パスワード変更、プロフィール編集）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 医院基本情報取得 | clinic_id | 医院情報 |
| 更新 | 医院基本情報編集 | clinic_id、更新内容 | 更新完了 |
| 作成 | スタッフ招待 | メールアドレス、ロール | 招待メール送信 |
| 取得 | スタッフ一覧取得 | clinic_id | スタッフリスト |
| 更新 | スタッフ権限変更 | user_id、新しいロール | 更新完了 |
| 削除 | スタッフ削除 | user_id | 削除完了 |
| 更新 | パスワード変更 | user_id、新パスワード | 更新完了 |

#### 処理フロー

1. 医院オーナーが設定画面にアクセス
2. 医院基本情報編集、またはスタッフ管理を選択
3. スタッフ招待の場合:
   - メールアドレスとロールを入力
   - 招待トークン生成
   - 招待メール送信（Supabase Auth）
   - 招待されたユーザーが初回ログイン時にパスワード設定
4. スタッフ削除の場合:
   - 削除確認ダイアログ表示
   - Supabase Authでユーザー削除
   - 医院との紐付け解除

#### データ構造（概念）

```yaml
Clinic:
  識別子: UUID
  基本情報:
    - name（医院名）（必須）
    - address（住所）
    - phone（電話番号）
    - email（メールアドレス）
    - logo_url（ロゴ画像URL）
    - brand_color（ブランドカラー）
  設定:
    - notification_enabled（通知有効/無効）
    - alert_settings（アラート設定）
  メタ情報:
    - created_at
    - updated_at
    - is_active（アクティブ/非アクティブ）
  関連:
    - Users（1対多: スタッフアカウント）
    - MonthlyData（1対多: 月次データ）
```

---

### 3.8 A-001: 管理ダッシュボード

#### 目的
全医院の状況を把握し、サービス全体の健全性を監視・分析する。

#### 主要機能

- 登録医院数・アクティブユーザー数表示
- 全医院の集計データ（平均売上、平均利益率、平均自費率等）
- 利用状況グラフ（ログイン数推移、機能利用率）
- アラート一覧（サポート依頼、エラー、異常値検知）
- 最近の活動ログ（新規登録、データ入力、レポート生成等）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 管理ダッシュボードデータ取得 | なし | 全医院集計データ、利用統計 |
| 取得 | アラート一覧取得 | なし | アラートリスト |

#### 処理フロー

1. システム管理者がログイン
2. 全医院データを集計
3. KPI計算（平均売上、利益率、自費率等）
4. 利用統計グラフ生成
5. アラート判定
6. ダッシュボード表示

---

### 3.9 A-002: 医院アカウント管理

#### 目的
医院の登録・管理・サポートを効率的に行い、導入支援と継続利用を促進する。

#### 主要機能

- 医院一覧・検索・フィルター（名称、地域、契約状態等）
- 新規医院登録（基本情報入力、オーナーアカウント作成、招待送信）
- 医院詳細閲覧（基本情報、データ入力状況、利用履歴、スタッフ一覧）
- アカウント有効化/無効化（契約終了時）
- サポート用データ閲覧・編集（医院データの確認・修正）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 医院一覧取得 | フィルター条件 | 医院リスト |
| 作成 | 新規医院登録 | 医院情報、オーナーメールアドレス | 医院作成、オーナーアカウント作成、招待送信 |
| 取得 | 医院詳細取得 | clinic_id | 医院詳細情報 |
| 更新 | アカウント有効化/無効化 | clinic_id、状態 | 更新完了 |
| 更新 | サポート用データ編集 | clinic_id、データID、更新内容 | 更新完了 |

---

### 3.10 A-003: システム設定

#### 目的
システム全体の設定を管理し、安定運用とメンテナンス効率化を実現する。

#### 主要機能

- 外部API設定（e-Stat、RESAS、Google Maps APIキー管理）
- メール通知テンプレート管理（招待メール、パスワードリセット、アラート通知等）
- マスタデータ管理（地域マスタ、業種マスタ等）
- システムログ閲覧（エラーログ、アクセスログ）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 外部API設定取得 | なし | API設定情報 |
| 更新 | 外部API設定更新 | APIキー、設定内容 | 更新完了 |
| 取得 | メールテンプレート一覧 | なし | テンプレートリスト |
| 更新 | メールテンプレート編集 | テンプレートID、内容 | 更新完了 |
| 取得 | システムログ取得 | 期間、ログ種別 | ログデータ |

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
Clinic（医院）:
  概要: 歯科医院の基本情報と設定を管理
  主要属性:
    - 基本情報: 医院名、住所、連絡先
    - ブランディング: ロゴ、カラー設定
    - 設定: 通知設定、アラート設定
  関連:
    - Users（1対多: スタッフアカウント）
    - MonthlyData（1対多: 月次経営データ）
    - Simulations（1対多: シミュレーション履歴）
    - Reports（1対多: レポート履歴）

User（ユーザー）:
  概要: システム利用者（医院スタッフ、システム管理者）
  主要属性:
    - 認証情報: メールアドレス、パスワードハッシュ
    - 権限: ロール（system_admin, clinic_owner, clinic_editor, clinic_viewer）
    - 所属: clinic_id（医院ユーザーの場合）
  関連:
    - Clinic（多対1: 医院ユーザーの場合）

MonthlyData（月次経営データ）:
  概要: 医院の月次経営実績データ
  主要属性:
    - 期間: 年月
    - 売上データ: 総売上、保険売上、自費売上
    - コストデータ: 固定費、変動費、人件費
    - 患者データ: 新患数、既患数、合計患者数
    - 設備データ: ユニット台数、稼働率
    - スタッフデータ: 正社員数、パート数、勤務時間
  関連:
    - Clinic（多対1）

Simulation（シミュレーション）:
  概要: 経営シミュレーション結果
  主要属性:
    - 目標設定: 目標売上、目標利益
    - 前提条件: 現在の設備・スタッフ状況
    - シミュレーション結果: 必要患者数、必要設備、戦略提案
  関連:
    - Clinic（多対1）

Report（レポート）:
  概要: 生成された経営レポート
  主要属性:
    - レポート種別: 月次/年次/シミュレーション
    - 対象期間: 開始日、終了日
    - ファイル情報: 形式（PDF/CSV）、URL、サイズ
  関連:
    - Clinic（多対1）

MarketAnalysis（診療圏分析）:
  概要: 診療圏分析結果
  主要属性:
    - 位置情報: 住所、緯度経度、診療圏範囲
    - 人口統計: 総人口、年齢分布、世帯数
    - 競合情報: 競合医院数、競合リスト
  関連:
    - Clinic（多対1）
```

### 4.2 エンティティ関係図

```
User ──────────┐
               │（多対1）
               ↓
Clinic ─┬─ MonthlyData     （1対多）
        ├─ Simulation      （1対多）
        ├─ Report          （1対多）
        └─ MarketAnalysis  （1対多）
```

### 4.3 バリデーションルール

```yaml
MonthlyData:
  year_month:
    - ルール: YYYY-MM-01形式、未来日付不可
    - 理由: 月次データの一意性確保、実績データのみ登録

  total_revenue:
    - ルール: 0以上の数値、必須
    - 理由: 売上は負にならない

  new_patients:
    - ルール: 0以上の整数
    - 理由: 患者数は負にならない

User:
  email:
    - ルール: 有効なメール形式、重複不可
    - 理由: 一意な識別子、通知送信先

  password:
    - ルール: 8文字以上、英数字混在推奨
    - 理由: セキュリティ確保

Clinic:
  name:
    - ルール: 1文字以上255文字以下、必須
    - 理由: 医院の一意な識別と表示
```

---

## 5. 制約事項

### 外部API制限

- **Google Maps API**: 月10,000リクエストまで無料、超過時は従量課金
- **e-Stat API**: レート制限あり（詳細は要確認）
- **RESAS API**: レート制限あり（詳細は要確認）
- **PILOT**: MVP版では手動CSVエクスポート運用（完全自動化には月額5,500円のWebhook転送機能が必要）

### 技術的制約

- **Supabase無料枠**: DB容量500MB、ストレージ1GB（超過時はProプラン移行必要）
- **Render.com無料枠**: 15分間アクセスなしで自動スリープ、初回アクセス時に起動時間が発生
- **PDF生成**: WeasyPrintはJavaScript実行不可（グラフは事前に画像化が必要）
- **CSV取込**: 1ファイル最大10,000行まで推奨（パフォーマンス考慮）

---

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: 診療圏分析データ統合取得

**トリガー**: ユーザーが「診療圏分析」ページを表示
**フロントエンドAPI**: GET /api/market-analysis/{clinic_id}
**バックエンド内部処理**:

1. Clinicテーブルから医院住所を取得
2. Community Geocoderで住所→緯度経度変換
3. e-Stat APIで人口統計取得（診療圏範囲内の小地域データ）
4. RESAS APIで商圏データ取得（産業構造、人口動態）
5. Google Maps Places APIで競合歯科医院検索（診療圏範囲内）
6. データを統合してJSON形式で返却

**結果**: 統合された診療圏分析データ（人口統計 + 競合情報 + 地図データ）
**外部サービス依存**: Community Geocoder, e-Stat API, RESAS API, Google Maps API

---

### 複合処理-002: 経営シミュレーション実行

**トリガー**: ユーザーが「シミュレーション実行」ボタンをクリック
**フロントエンドAPI**: POST /api/simulations
**バックエンド内部処理**:

1. 目標設定と前提条件を受信
2. 最新のMonthlyDataを取得（現状の経営数値）
3. 目標達成に必要な患者数を逆算
   - 計算式: 必要患者数 = (目標売上 - 固定費) / 患者単価
4. ユニット稼働率から必要なユニット台数を計算
   - 計算式: 必要ユニット数 = 必要患者数 / (1ユニットあたり対応可能患者数)
5. スタッフ対応能力から必要スタッフ数を計算
   - 計算式: 必要スタッフ数 = 必要患者数 / (1スタッフあたり対応可能患者数)
6. 自費率向上による利益インパクトを計算
7. 戦略提案リストを生成
8. シミュレーション結果をDBに保存

**結果**: シミュレーション結果（必要患者数、必要設備、戦略提案）
**外部サービス依存**: なし（内部計算のみ）

---

### 複合処理-003: レポート生成（PDF）

**トリガー**: ユーザーが「レポート生成」ボタンをクリック
**フロントエンドAPI**: POST /api/reports/generate
**バックエンド内部処理**:

1. レポート種別・期間・項目設定を受信
2. 指定期間のMonthlyDataを取得
3. KPI計算（売上、利益、粗利率等）
4. グラフデータ生成（matplotlib）→PNG画像→Base64エンコード
5. Jinja2テンプレートにデータを埋め込みHTML生成
6. WeasyPrintでPDF生成
7. Supabase StorageにPDF保存
8. ReportテーブルにレコードInsert

**結果**: 生成されたPDFのダウンロードURL
**外部サービス依存**: Supabase Storage

---

### 複合処理-004: PILOTデータ取込（CSV）

**トリガー**: ユーザーがCSVファイルをアップロード
**フロントエンドAPI**: POST /api/lstep-data/import
**バックエンド内部処理**:

1. CSVファイルを受信
2. PapaParse / Python csvでパース
3. データバリデーション（フォーマットチェック、必須項目確認）
4. 新患数、リコール率等の自動抽出
5. MonthlyDataテーブルにInsert/Update
6. 取込結果（成功件数、エラー件数、エラー詳細）を返却

**結果**: 取込結果サマリー
**外部サービス依存**: なし

---

## 7. 技術スタック

### フロントエンド

```yaml
言語・フレームワーク:
  - React 18
  - TypeScript 5
  - Vite 5

UIライブラリ:
  - MUI v6（Material-UI）

状態管理:
  - Zustand（グローバル状態）
  - React Query（サーバー状態、キャッシング）

ルーティング:
  - React Router v6

グラフ・チャート:
  - Recharts

フォーム管理:
  - React Hook Form

CSV処理:
  - PapaParse
```

### バックエンド

```yaml
言語・フレームワーク:
  - Python 3.11+
  - FastAPI

データベースSDK:
  - Supabase SDK（PostgreSQL接続、認証）

PDF生成:
  - WeasyPrint

データ分析:
  - Pandas（集計、ベンチマーク分析）

外部API連携:
  - Requests（HTTP通信）

テンプレートエンジン:
  - Jinja2（PDFテンプレート）
```

### データベース・認証

```yaml
サービス:
  - Supabase（PostgreSQL + Auth + Storage）

データベース:
  - PostgreSQL 15

認証:
  - Supabase Auth（メール+パスワード）

ストレージ:
  - Supabase Storage（レポートPDF保存）

リアルタイム:
  - Supabase Realtime（ダッシュボード自動更新）
```

### 外部API

```yaml
必須API（無料）:
  - e-Stat API（人口統計）
  - RESAS API（商圏データ）
  - Community Geocoder（ジオコーディング）
  - Google Maps API（地図、競合検索）

データ連携:
  - PILOT（手動CSVエクスポート）
```

### インフラ

```yaml
フロントエンド:
  - Vercel（無料枠）

バックエンド:
  - Render.com（無料枠）または Railway

CI/CD:
  - GitHub Actions（無料枠）
```

---

## 8. 必要な外部サービス・アカウント

### 必須サービス（無料）

| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| Supabase | データベース・認証・ストレージ | https://supabase.com | 無料枠: DB 500MB、5万MAU |
| e-Stat API | 人口統計データ取得 | https://www.e-stat.go.jp/api/ | 政府統計、完全無料 |
| RESAS API | 商圏データ・産業構造 | https://opendata.resas-portal.go.jp/ | 地域経済分析、無料 |
| Google Maps Platform | 地図表示・競合検索 | https://console.cloud.google.com | 無料枠: 月10,000リクエスト |
| Vercel | フロントエンドホスティング | https://vercel.com | 無料枠: 帯域100GB/月 |
| Render.com | バックエンドホスティング | https://render.com | 無料枠: 750時間/月 |

### オプションサービス（次フェーズ）

| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| PILOT Webhook転送機能 | リアルタイム顧客データ連携 | PILOT管理画面 | 月額5,500円 |
| MAP-STAR Web | 歯科医院特化診療圏分析 | https://www.medicalark.co.jp/ | 月額17,000円〜 |
| Supabase Pro | DB容量拡大・優先サポート | https://supabase.com | 月額$25 |

---

## 9. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

- 「あったらいいな」は実装しない
- 拡張可能性のための余分な要素は追加しない
- 将来の「もしかして」のための準備は禁止
- 今、ここで必要な最小限の要素のみを実装

拡張が必要になった時点で、Phase 11: 機能拡張オーケストレーターを使用して追加実装を行います。

### Phase 2: 自動化・高度化

- PILOT Webhook転送機能導入（リアルタイム自動連携）
- LINE Messaging API統合（友だち数自動取得）
- ベンチマーク機能実装（多医院データ比較）

### Phase 3: 高度な分析

- MAP-STAR Web連携（歯科医院特化診療圏分析）
- AIによる経営アドバイス生成
- 予測モデル（将来の売上・患者数予測）

### Phase 4: スケーリング

- Supabase Pro移行（医院数増加対応）
- Redis導入（キャッシュ、セッション管理）
- Celery導入（非同期タスク処理、大量レポート生成）

---

**作成日**: 2025年11月13日
**バージョン**: 1.0（MVP版）
