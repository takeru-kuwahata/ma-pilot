# Phase 6: ヒアリングシート機能 - 詳細要件定義書

**作成日**: 2025-12-26
**バージョン**: 1.0
**対象フェーズ**: Phase 6（Phase 5完了後に着手）

---

## 1. 機能概要

### 1.1 目的

クリニックの経営状況を定性的にヒアリングし、AI（Claude API）による分析で強み・課題を抽出、課題に対応する適切な企業をレコメンドすることで、以下を実現する：

- 定量データ（月次データ）だけでは見えない課題の可視化
- クリニックが抱える悩みに対する具体的な解決策の提示
- 提携企業とクリニックのマッチング自動化による新たな収益源

### 1.2 対象ユーザー

- **クリニック側**: clinic_owner、clinic_editor（ヒアリング回答）、clinic_viewer（結果閲覧）
- **運営側**: system_admin（全クリニック分析、企業マスタ管理）
- **Lstep連携**: Lstep ID経由でのアクセス（外部認証）

### 1.3 主要機能

1. **ヒアリングフォーム機能**
   - PDFベースの質問フォーム（チェックボックス、数値入力、自由記述）
   - 複数回実施可能（履歴管理）
   - Lstep ID連携によるシームレスアクセス

2. **AI分析機能**
   - Claude API（Sonnet 4.5）による自動分析
   - 強み・課題の抽出（カテゴリ別、優先度付き）
   - リアルタイム分析（ヒアリング保存直後に非同期実行）

3. **企業レコメンド機能**
   - ルールベースマッチング（MVP版）
   - 課題カテゴリと企業タグのマッチングによるスコア計算
   - 上位5社の表示（星評価付き）

4. **ダッシュボード統合**
   - タブUI追加（「数値分析」「ヒアリング分析」）
   - 最新分析結果、企業レコメンド、履歴一覧表示

5. **企業マスタ管理**
   - 企業CRUD操作（system_adminのみ）
   - CSV一括読込機能

6. **運営側分析機能**
   - 全クリニックのヒアリング一覧・集計
   - 課題トレンド分析

---

## 2. ユーザーストーリー

### クリニック側

**US-1: ヒアリング実施**
```
As a clinic_owner or clinic_editor,
I want to ヒアリングフォームに回答できる,
So that 自院の経営状況を定性的に記録できる
```

**受け入れ条件**:
- ヒアリングフォームページにアクセスできる
- 質問セクションごとに項目が整理されている
- チェックボックス、数値入力、自由記述が混在している
- 回答を保存すると自動的にAI分析が開始される
- 保存完了メッセージが表示される

**US-2: AI分析結果の閲覧**
```
As a clinic user (owner/editor/viewer),
I want to AI分析結果を閲覧できる,
So that 自院の強み・課題を客観的に把握できる
```

**受け入れ条件**:
- ダッシュボードの「ヒアリング分析」タブで結果を確認できる
- 強み（箇条書き）が表示される
- 課題（カテゴリ別、優先度付き）が表示される
- 分析ステータス（処理中、完了、失敗）が表示される

**US-3: 企業レコメンドの閲覧**
```
As a clinic user (owner/editor/viewer),
I want to 課題に対応する企業レコメンドを閲覧できる,
So that 具体的な解決策を検討できる
```

**受け入れ条件**:
- 課題カテゴリごとに企業が表示される
- マッチングスコアが星評価で表示される
- 企業詳細（名称、説明、連絡先、WebサイトURL）が表示される
- 上位5社のみ表示される

**US-4: ヒアリング履歴の閲覧**
```
As a clinic user,
I want to 過去のヒアリング履歴を閲覧できる,
So that 経営状況の変化を追跡できる
```

**受け入れ条件**:
- ヒアリング履歴一覧が表示される
- 実施日時、分析ステータスが確認できる
- 過去の分析結果を再表示できる

### 運営側（system_admin）

**US-5: 企業マスタ管理**
```
As a system_admin,
I want to 企業マスタを管理できる,
So that レコメンドする企業を追加・編集・削除できる
```

**受け入れ条件**:
- 企業一覧ページにアクセスできる
- 企業の新規作成、編集、削除ができる
- CSV一括読込ができる
- 企業の有効/無効切り替えができる

**US-6: 全クリニック分析**
```
As a system_admin,
I want to 全クリニックのヒアリング結果を集計・分析できる,
So that 業界全体の課題トレンドを把握できる
```

**受け入れ条件**:
- 全クリニックのヒアリング一覧が表示される
- 課題カテゴリ別の集計が表示される
- 期間絞り込みができる

---

## 3. 画面遷移図

```
[ログイン後トップ]
    |
    +-- [経営ダッシュボード] (/dashboard)
    |       |
    |       +-- [数値分析タブ] (既存機能)
    |       |
    |       +-- [ヒアリング分析タブ] (新規)
    |               |
    |               +-- 最新分析結果表示
    |               +-- 企業レコメンド表示
    |               +-- [ヒアリング履歴一覧]
    |                       |
    |                       +-- [過去の分析結果詳細]
    |
    +-- [ヒアリングフォーム] (/hearing) (新規ページ)
            |
            +-- 質問セクション1（基本情報）
            +-- 質問セクション2（課題・優先事項）
            +-- 質問セクション3（目標・計画）
            +-- [送信] → AI分析開始 → [ダッシュボードへ]

[管理者専用]
    |
    +-- [企業管理] (/admin/companies) (新規ページ)
            |
            +-- 企業一覧表示
            +-- [新規企業作成]
            +-- [企業編集]
            +-- [企業削除]
            +-- [CSV一括読込]
    |
    +-- [全クリニック分析] (/admin/hearings) (新規ページ)
            |
            +-- ヒアリング一覧
            +-- 課題カテゴリ別集計
            +-- 期間絞り込み
```

---

## 4. データフロー

### 4.1 ヒアリング回答 → AI分析 → 企業レコメンド

```
[クリニックユーザー]
    ↓ (1) ヒアリングフォーム入力
[フロントエンド]
    ↓ (2) POST /api/hearings
[バックエンド]
    ↓ (3) hearingsテーブルに保存
    ↓ (4) 非同期タスク実行（POST /api/hearings/{id}/analyze）
[Claude API]
    ↓ (5) プロンプト送信 → 分析結果取得
[バックエンド]
    ↓ (6) hearing_analysesテーブルに保存
    ↓ (7) 企業マッチングロジック実行
    ↓ (8) recommendationsテーブルに保存
[フロントエンド]
    ↓ (9) ダッシュボードで結果表示（GET /api/hearings/{id}/analysis）
[クリニックユーザー]
```

### 4.2 企業マスタCSV一括読込

```
[system_admin]
    ↓ (1) CSVファイル選択・アップロード
[フロントエンド]
    ↓ (2) POST /api/companies/import-csv
[バックエンド]
    ↓ (3) CSVパース（PapaParse or Python csv）
    ↓ (4) バリデーション（必須項目、重複チェック）
    ↓ (5) companiesテーブルに一括Insert
    ↓ (6) 取込結果サマリー返却
[フロントエンド]
    ↓ (7) 結果表示（成功XX件、エラーXX件）
[system_admin]
```

---

## 5. 外部API連携

### 5.1 Claude API連携

**API種類**: Claude API（Anthropic）
**モデル**: Claude Sonnet 4.5
**用途**: ヒアリング回答データの自動分析

**連携フロー**:
1. ヒアリング回答データ（JSON）をプロンプトに埋め込む
2. Claude APIにHTTPリクエスト送信
3. レスポンスから強み・課題を抽出
4. 分析結果をhearing_analysesテーブルに保存

**エラーハンドリング**:
- APIレート制限 → リトライロジック（指数バックオフ）
- タイムアウト → 30秒でタイムアウト、エラー記録
- API障害 → 分析ステータスを'failed'に設定

### 5.2 Lstep連携

**連携方式**: Lstep ID連携方式
**アクセスURL**: `https://ma-pilot.com/hearing?lstep_id={ID}`

**前提条件**:
- Lstep側で各クリニックに一意のIDを発行
- MA-Pilot側でlstep_idとclinic_idのマッピングテーブル管理

**認証フロー**:
1. Lstepから`?lstep_id={ID}`付きでアクセス
2. MA-Pilot側でlstep_idからclinic_idを取得
3. 初回アクセス時のみ簡易認証（メールアドレス確認）
4. 2回目以降はlstep_idのみでシームレスアクセス

**セキュリティ要件**:
- lstep_idはUUID v4形式（予測不可能）
- アクセストークンの有効期限設定（30日）
- 不正アクセス検知（連続失敗3回でロック）

---

## 6. セキュリティ要件

### 6.1 認証・認可

**ヒアリングフォーム**:
- 権限: clinic_owner、clinic_editor
- Lstep ID連携の場合はlstep_idベースの認証

**ヒアリング結果閲覧**:
- 権限: clinic_owner、clinic_editor、clinic_viewer
- 自医院のデータのみアクセス可能（RLS）

**企業マスタ管理**:
- 権限: system_adminのみ
- 他の権限レベルは閲覧不可

**全クリニック分析**:
- 権限: system_adminのみ

### 6.2 データ保護

**ヒアリング回答データ**:
- 機密レベル: 社外秘（経営課題、目標等）
- RLS設定: clinic_idでの完全分離
- 暗号化: SSL/TLS通信必須

**企業マスタ**:
- 機密レベル: 公開情報（企業名、連絡先等）
- RLS設定: 不要（全クリニックで共有）

**AI分析結果**:
- 機密レベル: 社外秘
- RLS設定: clinic_idでの完全分離
- Claude APIへの送信データ: 最小限（個人情報削除）

### 6.3 Claude APIセキュリティ

**APIキー管理**:
- 環境変数で管理（CLAUDE_API_KEY）
- コミット禁止（.gitignoreに追加）
- ローテーション: 3ヶ月ごと

**データ送信**:
- 個人情報（医院名、スタッフ名等）は送信しない
- 回答データのみ送信（数値、チェックボックス、自由記述）
- ログに機密情報を記録しない

---

## 7. パフォーマンス要件

### 7.1 応答時間

- **ヒアリングフォーム表示**: 1秒以内
- **ヒアリング保存**: 2秒以内
- **AI分析実行**: 非同期（10-30秒、バックグラウンド実行）
- **分析結果表示**: 1秒以内
- **企業レコメンド表示**: 1秒以内

### 7.2 スループット

- **同時ヒアリング実施**: 10ユーザーまで（MVP版）
- **Claude APIレート制限**: 60リクエスト/分（Anthropic制限）
- **企業マスタCSV一括読込**: 1,000件/1分以内

---

## 8. データ保持期間・履歴管理

### 8.1 ヒアリング履歴

**方針**: 複数回実施可能、全履歴保存（経年変化追跡）

**理由**:
- 開業1年以内の医院が対象のため、経営状況の変化を追跡する価値が高い
- 定期ヒアリング（3ヶ月ごと）を推奨する運用
- 「課題が改善したか」をデータで検証可能

**実装**:
- hearingsテーブルで全履歴を保存
- is_latestフラグで最新回答をマーク
- ダッシュボードで「最新のみ表示」「履歴比較表示」の切替UI

### 8.2 AI分析結果

**保持期間**: 永続保存（削除しない）

**理由**:
- ヒアリング履歴と紐付いているため、一貫性維持が必要
- 過去の分析結果との比較に使用

---

## 9. 制約事項・リスク

### 9.1 技術的制約

- **Claude API使用料**: 1回分析あたり数円〜数十円（クリニック数×月4回で試算が必要）
- **Claude APIレート制限**: 60リクエスト/分（Anthropic制限）
- **企業データの精査・編集**: クライアント側で初期データ提供が必要

### 9.2 ビジネス制約

- **Phase 5完了が前提**: バックエンド基盤（FastAPI、Supabase接続）が必須
- **企業マスタの初期データ取得**: Phase 6開始の前提条件

### 9.3 リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| AI分析精度の不確実性 | 高 | プロンプト改善、人間レビュー併用 |
| Claude APIレート制限 | 中 | リトライロジック、エラーハンドリング |
| Lstep連携の技術的障壁 | 中 | 外部リンク方式へのフォールバック |
| 企業マスタデータの不足 | 高 | Phase 6開始前に初期データ確保 |
| Claude APIコスト超過 | 中 | 月次利用上限設定、アラート通知 |

---

## 10. 未確定事項（Phase 5実装中に詰める）

- [ ] ヒアリングフォームの質問項目詳細（PDFのどこまでをWebフォーム化するか）
- [ ] Lstep ID連携の技術仕様（Lstep側の対応可否）
- [ ] AI分析プロンプトの詳細設計（入力・出力フォーマット）
- [ ] 企業マスタの初期データ（CSV提供時期）
- [ ] Claude APIの利用上限設定（月額予算）

---

## 11. Phase 6完了条件

- [ ] Supabaseテーブル4個追加完了（hearings、hearing_analyses、companies、recommendations）
- [ ] 企業マスタ初期データCSV読込完了
- [ ] ヒアリングフォーム動作確認完了
- [ ] AI分析（Claude API）動作確認完了
- [ ] 企業レコメンド表示確認完了
- [ ] ダッシュボードにヒアリング分析タブ追加完了
- [ ] 運営側分析画面動作確認完了
- [ ] Lstep連携テスト完了
- [ ] 全機能統合テスト完了

---

**作成者**: Claude Code
**最終更新日**: 2025-12-26
