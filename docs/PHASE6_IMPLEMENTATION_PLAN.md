# Phase 6: ヒアリングシート機能 - 実装計画書

**作成日**: 2025-12-26
**バージョン**: 1.0
**想定期間**: 2-3週間（Phase 5完了後）

---

## 1. 実装前提条件

### 1.1 Phase 5完了要件

- [ ] バックエンド基盤構築完了（FastAPI、Supabase接続）
- [ ] 認証API実装完了（login、logout）
- [ ] 既存30エンドポイント実装完了
- [ ] Render.comデプロイ完了
- [ ] Vercel + Render.com統合テスト完了

### 1.2 Phase 6開始前の準備

- [ ] 企業マスタ初期データ（CSV）準備完了（クライアント側）
- [ ] Claude APIキー取得完了
- [ ] ヒアリングフォームの質問項目確定（PDFベース）
- [ ] Lstep ID連携の技術仕様確定（Lstep側対応可否確認）

---

## 2. 実装タスク一覧（7ステップ）

| Step | タスク | 見積もり時間 | 担当 | 依存関係 |
|------|--------|------------|------|---------|
| 1 | DB・型定義拡張 | 1-2日 | バックエンド | なし |
| 2 | 企業マスタ管理 | 2-3日 | フル | Step 1 |
| 3 | ヒアリングフォーム | 3-4日 | フロントエンド | Step 1 |
| 4 | AI分析機能 | 3-4日 | バックエンド | Step 1 |
| 5 | 企業レコメンド | 2-3日 | フル | Step 1, 4 |
| 6 | ダッシュボード統合 | 2-3日 | フロントエンド | Step 3, 4, 5 |
| 7 | 運営側分析機能 | 2-3日 | フル | Step 1, 4 |

**合計見積もり**: 15-22日（2-3週間）

---

## 3. 各ステップの詳細

### Step 1: DB・型定義拡張（1-2日）

**目的**: ヒアリング機能に必要なテーブル・型定義を追加

**タスク**:
1. Supabaseテーブル作成（4テーブル）
   - hearings
   - hearing_analyses
   - companies
   - recommendations
2. インデックス作成
3. RLSポリシー設定
4. トリガー作成（updated_at自動更新、is_latest自動更新）
5. フロントエンド型定義追加（`frontend/src/types/phase6.ts`）
6. バックエンド型定義追加（`backend/src/types/phase6.py`）

**成果物**:
- [ ] `PHASE6_DATABASE_DESIGN.md`記載のDDL実行完了
- [ ] `frontend/src/types/phase6.ts`作成完了
- [ ] `backend/src/types/phase6.py`作成完了

**テスト**:
- Supabase Studio上でテーブル作成確認
- RLSポリシーが正しく動作することを確認（SELECT/INSERT/UPDATE/DELETE）

---

### Step 2: 企業マスタ管理（2-3日）

**目的**: 企業CRUD操作とCSV一括読込機能を実装

**タスク**:
1. バックエンド実装
   - `GET /api/companies` - 企業一覧取得
   - `POST /api/companies` - 企業作成
   - `PUT /api/companies/{id}` - 企業更新
   - `DELETE /api/companies/{id}` - 企業削除（ソフト削除）
   - `POST /api/companies/import-csv` - CSV一括読込
2. フロントエンド実装
   - `CompanyManagement.tsx`（管理者専用ページ）
   - 企業一覧テーブル表示
   - 企業作成・編集ダイアログ
   - CSV一括読込ダイアログ
3. CSV一括読込機能実装
   - CSVパース（PapaParse or Python csv）
   - バリデーション
   - エラーハンドリング

**成果物**:
- [ ] バックエンドAPI 5エンドポイント実装完了
- [ ] `CompanyManagement.tsx`実装完了
- [ ] CSV一括読込機能実装完了

**テスト**:
- 企業CRUD操作が正常に動作することを確認
- CSV一括読込（正常系・異常系）のテスト
- 50件サンプルデータ登録テスト

---

### Step 3: ヒアリングフォーム（3-4日）

**目的**: PDFベースの質問フォームをWebフォーム化

**タスク**:
1. バックエンド実装
   - `POST /api/hearings` - ヒアリング回答保存
   - `GET /api/hearings` - ヒアリング履歴取得
   - `GET /api/hearings/latest` - 最新ヒアリング取得
2. フロントエンド実装
   - `HearingForm.tsx`（ページコンポーネント）
   - `HearingFormSections.tsx`（セクションコンポーネント）
   - ステッパーUI（3ステップ）
   - バリデーション実装（React Hook Form）
3. Lstep ID連携実装（オプション、技術仕様確定後）
   - URLパラメータ `?lstep_id={ID}` 処理
   - lstep_idからclinic_id取得

**成果物**:
- [ ] バックエンドAPI 3エンドポイント実装完了
- [ ] `HearingForm.tsx`実装完了
- [ ] `HearingFormSections.tsx`実装完了
- [ ] Lstep ID連携実装完了（仕様確定の場合）

**テスト**:
- フォーム入力〜送信の一連の流れをテスト
- バリデーションテスト（必須項目、数値範囲）
- Lstep ID連携テスト（仕様確定の場合）

---

### Step 4: AI分析機能（3-4日）

**目的**: Claude APIによるヒアリング回答の自動分析

**タスク**:
1. Claude API統合実装
   - `ClaudeApiService`実装（Python）
   - プロンプトテンプレート実装
   - レスポンスパース処理
   - エラーハンドリング（レート制限、タイムアウト）
   - リトライロジック実装
2. バックエンド実装
   - `POST /api/hearings/{id}/analyze` - AI分析実行（内部API）
   - `GET /api/hearings/{id}/analysis` - AI分析結果取得
   - 非同期タスク実装（BackgroundTasks）
3. 環境変数設定
   - `.env.local`にClaude API設定追加
   - Render.comに環境変数設定

**成果物**:
- [ ] `ClaudeApiService`実装完了
- [ ] バックエンドAPI 2エンドポイント実装完了
- [ ] Claude APIキー設定完了
- [ ] プロンプトテンプレート実装完了

**テスト**:
- Claude API呼び出しテスト（正常系・異常系）
- プロンプト生成テスト
- レスポンスパーステスト
- エラーハンドリングテスト（レート制限、タイムアウト）

---

### Step 5: 企業レコメンド（2-3日）

**目的**: AI分析結果に基づく企業マッチング機能を実装

**タスク**:
1. バックエンド実装
   - `GET /api/hearings/{id}/recommendations` - 企業レコメンド取得
   - マッチングロジック実装（ルールベース）
   - スコア計算ロジック実装
2. フロントエンド実装
   - `CompanyRecommendation.tsx`（コンポーネント）
   - 星評価表示（MUI Rating）
   - 企業詳細カード表示

**成果物**:
- [ ] バックエンドAPI 1エンドポイント実装完了
- [ ] マッチングロジック実装完了
- [ ] `CompanyRecommendation.tsx`実装完了

**テスト**:
- マッチングロジックテスト（各種パターン）
- スコア計算テスト
- 企業レコメンド表示テスト

**マッチングロジック仕様**:
```
マッチングスコア = カテゴリ完全一致(50) + タグマッチング(10×N, 最大30) + 優先度加点(high:20, medium:10, low:5)
最大100点
```

---

### Step 6: ダッシュボード統合（2-3日）

**目的**: 既存ダッシュボードにヒアリング分析タブを追加

**タスク**:
1. フロントエンド実装
   - `Dashboard.tsx`改修（タブUI追加）
   - `AIAnalysisCard.tsx`（コンポーネント）
   - `HearingResult.tsx`（ページコンポーネント）
   - 最新ヒアリング取得API呼び出し
   - ポーリング実装（分析中のみ、5秒間隔）
2. ルーティング設定
   - `/hearing` - ヒアリングフォーム
   - `/hearing/result` - ヒアリング結果

**成果物**:
- [ ] `Dashboard.tsx`改修完了
- [ ] `AIAnalysisCard.tsx`実装完了
- [ ] `HearingResult.tsx`実装完了
- [ ] ルーティング設定完了

**テスト**:
- タブ切り替えテスト
- 最新ヒアリング表示テスト
- 分析中のポーリングテスト
- 企業レコメンド表示テスト

---

### Step 7: 運営側分析機能（2-3日）

**目的**: 全クリニックのヒアリング結果を集計・分析

**タスク**:
1. バックエンド実装
   - `GET /api/admin/hearings` - 全クリニックヒアリング一覧・集計
   - 集計ロジック実装（課題カテゴリ別、期間絞り込み）
2. フロントエンド実装
   - `AdminHearings.tsx`（管理者専用ページ）
   - ヒアリング一覧テーブル表示
   - 課題カテゴリ別集計グラフ表示（Recharts）
   - 期間絞り込みフィルター

**成果物**:
- [ ] バックエンドAPI 1エンドポイント実装完了
- [ ] `AdminHearings.tsx`実装完了
- [ ] 集計グラフ表示実装完了

**テスト**:
- 全クリニックヒアリング一覧表示テスト
- 課題カテゴリ別集計テスト
- 期間絞り込みテスト

---

## 4. 依存関係図

```
Step 1: DB・型定義拡張
    ↓
  ┌───┴───┬─────────┬─────────┐
  ↓       ↓         ↓         ↓
Step 2  Step 3    Step 4    Step 7
企業管理 フォーム   AI分析   運営分析
  ↓       ↓         ↓
  └───┬───┴─────────┘
      ↓
    Step 5
  企業レコメンド
      ↓
    Step 6
  ダッシュボード統合
```

**並行実装可能なタスク**:
- Step 2（企業管理）とStep 3（ヒアリングフォーム）
- Step 2とStep 4（AI分析機能）
- Step 2とStep 7（運営側分析）

---

## 5. リスク管理

### 5.1 リスク一覧

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| Claude APIキー取得遅延 | 高 | 低 | Phase 5中に取得完了 |
| 企業マスタ初期データ未提供 | 高 | 中 | Step 2開始前に確認、未提供の場合はサンプルデータで代替 |
| Lstep連携仕様未確定 | 中 | 中 | Step 3でスキップ、Phase 7で追加実装 |
| Claude APIレート制限 | 中 | 低 | リトライロジック、キュー管理で対応 |
| AI分析精度不足 | 中 | 中 | プロンプト改善、人間レビュー併用 |
| 実装遅延（見積もり超過） | 中 | 中 | 優先度低い機能（Lstep連携）をPhase 7に延期 |

### 5.2 クリティカルパス

**最優先タスク**:
1. Step 1（DB・型定義拡張） - 全ステップの前提
2. Step 4（AI分析機能） - 本機能の中核

**遅延時の優先順位**:
1. Step 1 → Step 4 → Step 3 → Step 5 → Step 6（MVP版）
2. Step 2、Step 7は後回し可能

---

## 6. テスト計画

### 6.1 ユニットテスト

**対象**:
- Claude APIプロンプト生成ロジック
- レスポンスパースロジック
- マッチングロジック
- バリデーションロジック

**ツール**: Jest（フロントエンド）、pytest（バックエンド）

### 6.2 統合テスト

**対象**:
- ヒアリング回答 → AI分析 → 企業レコメンドの一連の流れ
- CSV一括読込の一連の流れ
- エラーハンドリング（Claude APIエラー、レート制限等）

### 6.3 E2Eテスト

**対象**:
- ヒアリングフォーム入力〜送信〜結果表示
- 企業管理CRUD操作

**ツール**: Playwright（オプション）

---

## 7. デプロイ計画

### 7.1 デプロイ前チェックリスト

- [ ] 全12エンドポイントのAPI動作確認完了
- [ ] 7コンポーネントのフロントエンド動作確認完了
- [ ] 企業マスタ初期データ（50件）登録完了
- [ ] Claude APIキー設定完了（Render.com環境変数）
- [ ] Lstep連携テスト完了（仕様確定の場合）
- [ ] 全機能統合テスト完了

### 7.2 デプロイ手順

1. **バックエンドデプロイ（Render.com）**:
   - 環境変数設定（CLAUDE_API_KEY等）
   - GitHubプッシュ → 自動デプロイ
   - デプロイ完了確認（Render.comダッシュボード）

2. **フロントエンドデプロイ（Vercel）**:
   - GitHubプッシュ → 自動デプロイ
   - デプロイ完了確認（Vercelダッシュボード）

3. **統合テスト（本番環境）**:
   - ヒアリング実施テスト
   - AI分析テスト
   - 企業レコメンド表示テスト

---

## 8. Phase 6完了チェックリスト

### 8.1 機能実装

- [ ] Supabaseテーブル4個追加完了（hearings、hearing_analyses、companies、recommendations）
- [ ] 企業マスタ初期データCSV読込完了（50件以上）
- [ ] ヒアリングフォーム動作確認完了
- [ ] AI分析（Claude API）動作確認完了
- [ ] 企業レコメンド表示確認完了
- [ ] ダッシュボードにヒアリング分析タブ追加完了
- [ ] 運営側分析画面動作確認完了
- [ ] Lstep連携テスト完了（仕様確定の場合）

### 8.2 API実装

- [ ] 12エンドポイント全て実装完了
- [ ] 全エンドポイントの動作確認完了
- [ ] エラーハンドリング実装完了

### 8.3 コンポーネント実装

- [ ] 7コンポーネント全て実装完了
- [ ] 全コンポーネントの動作確認完了
- [ ] レスポンシブ対応確認完了

### 8.4 テスト

- [ ] ユニットテスト実装完了
- [ ] 統合テスト実装完了
- [ ] E2Eテスト実装完了（オプション）
- [ ] 全機能統合テスト完了

### 8.5 ドキュメント

- [ ] PHASE6_HEARING_REQUIREMENTS.md 作成完了
- [ ] PHASE6_DATABASE_DESIGN.md 作成完了
- [ ] PHASE6_API_DESIGN.md 作成完了
- [ ] PHASE6_COMPONENT_DESIGN.md 作成完了
- [ ] PHASE6_AI_INTEGRATION.md 作成完了
- [ ] PHASE6_COMPANY_CSV_FORMAT.md 作成完了
- [ ] PHASE6_IMPLEMENTATION_PLAN.md 作成完了（本ファイル）

### 8.6 デプロイ

- [ ] バックエンドデプロイ完了（Render.com）
- [ ] フロントエンドデプロイ完了（Vercel）
- [ ] 本番環境統合テスト完了

---

## 9. Phase 7への引き継ぎ事項

### 9.1 未実装機能（将来拡張）

- Lstep連携の詳細実装（仕様未確定の場合）
- AI分析プロンプトの改善（精度向上）
- 企業レコメンドのML化（ルールベース→機械学習）
- ヒアリング比較機能（過去回答との比較）

### 9.2 既知の課題

- Claude APIコストの最適化
- AI分析精度の向上
- 企業マスタの充実（100社以上）

---

## 10. 緊急時の連絡先

| 役割 | 担当者 | 連絡先 |
|------|--------|--------|
| プロジェクトオーナー | 桑畑様 | （メールアドレス） |
| Claude Code担当 | Claude Code | - |
| Anthropic サポート | Anthropic | support@anthropic.com |
| Supabase サポート | Supabase | support@supabase.com |

---

**作成者**: Claude Code
**最終更新日**: 2025-12-26
