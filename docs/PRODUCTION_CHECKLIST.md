# MA-Pilot 本番環境デプロイチェックリスト

このチェックリストは、MA-Pilotを本番環境にデプロイする前に確認すべき項目をまとめたものです。

## デプロイ前チェックリスト

### 1. 環境変数設定

#### Vercel（フロントエンド）
- [ ] `VITE_SUPABASE_URL` が設定されている
- [ ] `VITE_SUPABASE_ANON_KEY` が設定されている
- [ ] `VITE_BACKEND_URL` が設定されている（Render.comのURL）
- [ ] すべての環境変数がProduction環境に割り当てられている

#### Render.com（バックエンド）
- [ ] `PYTHON_VERSION=3.12` が設定されている
- [ ] `SUPABASE_URL` が設定されている
- [ ] `SUPABASE_KEY`（Service Role Key）が設定されている
- [ ] `ENVIRONMENT=production` が設定されている
- [ ] `FRONTEND_URL` が設定されている（VercelのURL）
- [ ] `LOG_LEVEL=WARNING` が設定されている

#### GitHub Secrets
- [ ] `VERCEL_TOKEN` が設定されている
- [ ] `VERCEL_ORG_ID` が設定されている
- [ ] `VERCEL_PROJECT_ID` が設定されている
- [ ] `RENDER_DEPLOY_HOOK` が設定されている
- [ ] `BACKEND_URL` が設定されている
- [ ] `VITE_SUPABASE_URL` が設定されている
- [ ] `VITE_SUPABASE_ANON_KEY` が設定されている

---

### 2. Supabaseデータベース

#### スキーマ
- [ ] `backend/supabase_schema.sql` を実行済み
- [ ] すべてのテーブルが作成されている
- [ ] インデックスが作成されている
- [ ] 外部キー制約が設定されている

#### Row Level Security（RLS）
- [ ] すべてのテーブルでRLSが有効化されている
- [ ] `clinics` テーブルのRLSポリシーが設定されている
- [ ] `monthly_data` テーブルのRLSポリシーが設定されている
- [ ] `simulations` テーブルのRLSポリシーが設定されている
- [ ] `reports` テーブルのRLSポリシーが設定されている
- [ ] `market_analyses` テーブルのRLSポリシーが設定されている

#### 認証設定
- [ ] Email認証が有効化されている
- [ ] Email確認が有効（Enable email confirmations: ON）
- [ ] セキュアなメール変更が有効（Secure email change: ON）
- [ ] パスワードポリシーが適切に設定されている

#### ストレージ
- [ ] `reports` バケットが作成されている
- [ ] `reports` バケットのRLSが有効化されている
- [ ] ファイルサイズ制限が設定されている（例: 最大10MB）

---

### 3. セキュリティ設定

#### APIキー・認証情報
- [ ] `.env`、`.env.local` がコミットされていない
- [ ] `.gitignore` に環境変数ファイルが含まれている
- [ ] Supabase Service Role Keyがバックエンドのみで使用されている
- [ ] Supabase Anon Keyがフロントエンドで使用されている
- [ ] ハードコードされたAPIキーが存在しない

#### CORS設定
- [ ] バックエンドのCORSが本番URLのみに制限されている
- [ ] `localhost` URLが本番環境から削除されている（開発時のみ）
- [ ] `allow_credentials=True` が設定されている

#### HTTPS
- [ ] Vercelで自動HTTPS化が有効
- [ ] Render.comで自動HTTPS化が有効
- [ ] すべてのAPI通信がHTTPSで行われる

#### その他
- [ ] SQLインジェクション対策（Supabase SDK使用）
- [ ] XSS対策（React標準エスケープ）
- [ ] CSRF対策（必要に応じて実装）

---

### 4. コード品質

#### TypeScript
- [ ] `npm run type-check` がエラーなしで通る
- [ ] `tsc --noEmit` がエラーなしで通る
- [ ] strict モードが有効

#### Lint
- [ ] `npm run lint` がエラーなしで通る（フロントエンド）
- [ ] `flake8` がエラーなしで通る（バックエンド）
- [ ] 未使用の変数・importが削除されている

#### コンソールログ
- [ ] `console.log` が本番コードから削除されている
- [ ] デバッグ用コードが削除されている

#### エラーハンドリング
- [ ] すべてのAPIエンドポイントでエラーハンドリング実装
- [ ] フロントエンドでエラー境界（Error Boundary）実装
- [ ] ユーザーフレンドリーなエラーメッセージ

---

### 5. テスト

#### バックエンド
- [ ] `pytest` がすべて通る
- [ ] APIエンドポイントのテストがある
- [ ] 認証・認可のテストがある
- [ ] エラーケースのテストがある

#### フロントエンド
- [ ] ビルドが成功する（`npm run build`）
- [ ] 手動でUIテストを実施済み
- [ ] 主要なユーザーフローが動作する

#### 統合テスト
- [ ] フロントエンド↔バックエンド通信が成功
- [ ] バックエンド↔Supabase通信が成功
- [ ] 認証フローが正常に動作

---

### 6. パフォーマンス

#### フロントエンド
- [ ] ビルドサイズが適切（目安: < 1MB）
- [ ] Code Splittingが実装されている
- [ ] 画像が最適化されている
- [ ] 不要な依存関係が削除されている

#### バックエンド
- [ ] APIレスポンスタイムが適切（目安: < 500ms）
- [ ] データベースクエリが最適化されている
- [ ] N+1クエリ問題がない
- [ ] インデックスが適切に設定されている

#### データベース
- [ ] 頻繁にクエリされるカラムにインデックス作成
- [ ] 不要なデータが削除されている
- [ ] バックアップ設定が有効

---

### 7. モニタリング・ログ

#### Vercel
- [ ] Vercel Analyticsが有効
- [ ] エラートラッキングが有効
- [ ] ビルドログが確認できる

#### Render.com
- [ ] ヘルスチェックが設定されている（`/health`）
- [ ] メトリクスが表示される
- [ ] ログが確認できる
- [ ] アラート設定（オプション）

#### Supabase
- [ ] APIリクエスト数が確認できる
- [ ] データベース使用量が確認できる
- [ ] 認証ユーザー数が確認できる

---

### 8. バックアップ・リカバリ

#### データベース
- [ ] Supabaseの自動バックアップが有効
- [ ] 手動バックアップ手順が文書化されている
- [ ] リストア手順が文書化されている

#### コード
- [ ] GitHubにすべてのコードがpush済み
- [ ] mainブランチが保護されている
- [ ] タグ付けされている（例: `v1.0.0`）

#### 設定
- [ ] すべての環境変数が文書化されている
- [ ] デプロイ手順が文書化されている
- [ ] ロールバック手順が文書化されている

---

### 9. ドキュメント

- [ ] README.mdが最新
- [ ] DEPLOYMENT_GUIDE.mdが完全
- [ ] PRODUCTION_CHECKLIST.md（本ファイル）が確認済み
- [ ] API仕様書が作成されている（オプション）
- [ ] ユーザーマニュアルが作成されている（オプション）

---

### 10. 本番デプロイ後の確認

#### フロントエンド
- [ ] Vercel URLにアクセスできる
- [ ] ログイン画面が表示される
- [ ] UIが正しく表示される
- [ ] ブラウザコンソールにエラーがない

#### バックエンド
- [ ] Render.com URLにアクセスできる
- [ ] `/health` エンドポイントが200 OKを返す
- [ ] `/` ルートエンドポイントが応答する
- [ ] `/docs` でAPI仕様が確認できる

#### API統合
- [ ] フロントエンドからバックエンドAPIにアクセスできる
- [ ] ログイン・ログアウトが正常に動作
- [ ] データの取得・作成・更新・削除が正常に動作
- [ ] CORSエラーが発生しない

#### Supabase
- [ ] 認証が正常に動作
- [ ] データベース操作が正常に動作
- [ ] RLSが正しく機能している（他の医院のデータが見えない）
- [ ] ストレージ（ファイルアップロード）が正常に動作

#### パフォーマンス
- [ ] ページ読み込み時間が適切（< 3秒）
- [ ] APIレスポンスタイムが適切（< 1秒）
- [ ] データベースクエリが適切（< 100ms）

---

## デプロイ後の定期チェック

### 毎日
- [ ] ヘルスチェックエンドポイント確認
- [ ] エラーログ確認
- [ ] ユーザーからの問い合わせ確認

### 毎週
- [ ] Vercel Analyticsレビュー
- [ ] Render.com Metricsレビュー
- [ ] Supabase使用量確認
- [ ] セキュリティアラート確認

### 毎月
- [ ] 依存関係の更新（セキュリティパッチ）
- [ ] データベースバックアップ確認
- [ ] パフォーマンステスト
- [ ] コスト確認（無料枠の使用状況）

---

## トラブル発生時の対応

### 即座に実行
1. [ ] ログを確認（Vercel/Render.com/Supabase）
2. [ ] エラーメッセージを記録
3. [ ] 影響範囲を特定
4. [ ] 必要に応じてロールバック

### ロールバック手順
- **フロントエンド**: Vercelダッシュボード > Deployments > 以前のデプロイをPromote
- **バックエンド**: Render.comダッシュボード > Events > 以前のデプロイをRedeploy
- **データベース**: Supabase > Database > Backup から復元

---

## 承認

- [ ] 開発者チェック完了
- [ ] レビュアーチェック完了
- [ ] デプロイ責任者承認
- [ ] デプロイ実行日時: _______________
- [ ] デプロイ実行者: _______________

---

## 参考リンク

- [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md)
- [SECRET_SETUP.md](../.github/SECRET_SETUP.md)
- [Vercel Documentation](https://vercel.com/docs)
- [Render.com Documentation](https://render.com/docs)
- [Supabase Documentation](https://supabase.com/docs)
