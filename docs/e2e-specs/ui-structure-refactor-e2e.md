# E2Eテスト仕様書: UI構造リファクタリング

## 概要

- **対象機能**: 権限別ルーティング、エリア分離、system_adminモード切替
- **テスト観点**: ユーザー体験フローの正常系検証
- **前提条件**: バックエンドAPI正常動作、テストデータ準備済み

## テストアカウント

| ロール | メールアドレス | パスワード | 所属クリニック |
|--------|--------------|-----------|--------------|
| system_admin | kuwahata@idw-japan.net | advance2026 | なし |
| clinic_owner | owner@test.com | TestPass123! | テストクリニックA |
| clinic_editor | editor@test.com | TestPass123! | テストクリニックA |
| clinic_viewer | viewer@test.com | TestPass123! | テストクリニックA |

---

## テストケース一覧（合計8件）

| ID | シナリオ | 対象フロー | 期待結果 |
|----|---------|-----------|---------|
| E2E-001 | system_adminログイン・運営エリア表示 | ログイン→自動リダイレクト→運営者メニュー確認 | `/admin/dashboard`表示、運営者専用メニュー表示 |
| E2E-002 | system_adminモード切替・クリニック選択 | 運営者モード→医院モード→クリニック選択→メニュー切替 | 医院メニュー表示、選択クリニック名表示、選択状態保持 |
| E2E-003 | clinic_ownerログイン・医院エリア全機能アクセス | ログイン→医院ダッシュボード表示→全メニューアクセス | `/clinic/dashboard`表示、全メニュー項目表示・アクセス可能 |
| E2E-004 | clinic_editorログイン・編集者メニュー表示 | ログイン→編集者メニュー表示→編集機能アクセス | 編集者メニュー（ダッシュボード、基礎データ、診療圏、シミュレーション、レポート、印刷物）のみ表示 |
| E2E-005 | clinic_viewerログイン・閲覧者メニュー表示 | ログイン→閲覧者メニュー表示→閲覧機能のみアクセス | 閲覧者メニュー（ダッシュボード、診療圏、レポート、印刷物）のみ表示 |
| E2E-006 | 旧URLからの自動リダイレクト | `/dashboard`にアクセス→`/clinic/dashboard`へリダイレクト | 全旧URLが対応する`/clinic/*`へリダイレクト |
| E2E-007 | 不正アクセス防止（認証チェック） | 未ログイン状態で`/clinic/*`アクセス→ログイン画面へ | `/login`へリダイレクト、URLパラメータにリダイレクト先保持 |
| E2E-008 | 不正アクセス防止（権限チェック） | clinic_viewerが`/admin/*`アクセス→403エラー | `/forbidden`ページ表示、適切なエラーメッセージ |

---

## 詳細シナリオ

### E2E-001: system_adminログイン・運営エリア表示

**目的**: system_adminが正しく運営エリアにリダイレクトされ、運営者専用メニューが表示されることを確認

**前提条件**:
- system_adminアカウント（kuwahata@idw-japan.net）が存在する
- 未ログイン状態でテストを開始

**操作手順**:
1. `/login`にアクセス
2. メールアドレス: `kuwahata@idw-japan.net`、パスワード: `advance2026`を入力
3. 「ログイン」ボタンをクリック
4. ページ遷移を確認
5. ヘッダーとメニューを目視確認

**期待結果**:
- URLが`/admin/dashboard`に自動遷移
- ページタイトルが「管理ダッシュボード」
- 左サイドメニューに以下が表示される:
  - 管理ダッシュボード
  - 医院アカウント管理
  - システム設定
  - 価格表管理
  - 印刷物受注管理
- ヘッダー右上に「医院モードへ切替」ボタンが表示される
- 医院向けメニュー（ダッシュボード、基礎データ管理等）は表示されない

**検証ポイント**:
- 権限による自動リダイレクト機能
- 運営者専用メニューのフィルタリング
- モード切替UIの表示

---

### E2E-002: system_adminモード切替・クリニック選択

**目的**: system_adminが医院モードに切り替え、任意のクリニックを選択して操作できることを確認

**前提条件**:
- E2E-001完了状態（system_adminでログイン済み、運営エリア表示中）
- テストクリニックA、テストクリニックBが存在する

**操作手順**:
1. ヘッダー右上の「医院モードへ切替」ボタンをクリック
2. `/clinic/dashboard`へ自動遷移
3. ヘッダーにクリニック選択ドロップダウンが表示されることを確認
4. ドロップダウンをクリックし、「テストクリニックA」を選択
5. 左サイドメニューを確認
6. `/clinic/data-management`に遷移
7. ヘッダーのクリニック名が保持されていることを確認
8. ドロップダウンで「テストクリニックB」に変更
9. ページ内容が切り替わることを確認

**期待結果**:
- ボタンクリック後、URLが`/clinic/dashboard`に遷移
- ヘッダーに「クリニック選択」ドロップダウンが表示される
- ドロップダウンには全クリニック名が表示される
- クリニック選択後、ヘッダーに選択クリニック名が表示される
- 左サイドメニューが医院向けメニューに切り替わる（clinic_owner相当の全メニュー）
- ページ遷移しても選択クリニックが保持される
- クリニック切替時、ページ内容がリアルタイムで更新される
- ヘッダー右上のボタンが「運営者モードへ切替」に変わる

**検証ポイント**:
- モード切替によるルーティング変更
- クリニック選択UIの表示・動作
- 選択状態の保持（React状態管理）
- メニューの動的切り替え

---

### E2E-003: clinic_ownerログイン・医院エリア全機能アクセス

**目的**: clinic_ownerが医院エリアにリダイレクトされ、全ての医院機能にアクセスできることを確認

**前提条件**:
- clinic_ownerアカウント（owner@test.com）が存在する
- テストクリニックAに所属している
- 未ログイン状態でテストを開始

**操作手順**:
1. `/login`にアクセス
2. メールアドレス: `owner@test.com`、パスワード: `TestPass123!`を入力
3. 「ログイン」ボタンをクリック
4. ページ遷移を確認
5. 左サイドメニューの全項目を確認
6. 各メニュー項目をクリックし、ページ遷移を確認

**期待結果**:
- URLが`/clinic/dashboard`に自動遷移
- ページタイトルが「経営ダッシュボード」
- ヘッダーにクリニック名「テストクリニックA」が表示される
- 左サイドメニューに以下が全て表示される:
  - ダッシュボード
  - 基礎データ管理
  - 診療圏分析
  - 経営シミュレーション
  - レポート管理
  - 印刷物発注
  - 発注履歴
  - 医院設定
  - スタッフ管理
- 各メニュー項目クリック時、対応するページに正常遷移する
- ヘッダーに「モード切替」ボタンは表示されない（clinic系ロールはモード切替不可）

**検証ポイント**:
- 権限による自動リダイレクト機能
- clinic_owner用の全メニュー表示
- 全機能へのアクセス権限

---

### E2E-004: clinic_editorログイン・編集者メニュー表示

**目的**: clinic_editorが医院エリアにリダイレクトされ、編集者権限に応じたメニューのみ表示されることを確認

**前提条件**:
- clinic_editorアカウント（editor@test.com）が存在する
- テストクリニックAに所属している
- 未ログイン状態でテストを開始

**操作手順**:
1. `/login`にアクセス
2. メールアドレス: `editor@test.com`、パスワード: `TestPass123!`を入力
3. 「ログイン」ボタンをクリック
4. ページ遷移を確認
5. 左サイドメニューを確認
6. 表示されているメニュー項目のみクリック可能であることを確認
7. ブラウザのアドレスバーに`/clinic/staff-management`を直接入力してアクセス試行

**期待結果**:
- URLが`/clinic/dashboard`に自動遷移
- ヘッダーにクリニック名「テストクリニックA」が表示される
- 左サイドメニューに以下のみ表示される:
  - ダッシュボード
  - 基礎データ管理
  - 診療圏分析
  - 経営シミュレーション
  - レポート管理
  - 印刷物発注
  - 発注履歴
- 以下は表示されない:
  - 医院設定
  - スタッフ管理
- 直接URLアクセス時、`/forbidden`ページへリダイレクト

**検証ポイント**:
- 権限別メニューフィルタリング
- 編集者権限の範囲
- 直接URLアクセス時の権限チェック

---

### E2E-005: clinic_viewerログイン・閲覧者メニュー表示

**目的**: clinic_viewerが医院エリアにリダイレクトされ、閲覧者権限に応じたメニューのみ表示されることを確認

**前提条件**:
- clinic_viewerアカウント（viewer@test.com）が存在する
- テストクリニックAに所属している
- 未ログイン状態でテストを開始

**操作手順**:
1. `/login`にアクセス
2. メールアドレス: `viewer@test.com`、パスワード: `TestPass123!`を入力
3. 「ログイン」ボタンをクリック
4. ページ遷移を確認
5. 左サイドメニューを確認
6. ブラウザのアドレスバーに`/clinic/data-management`を直接入力してアクセス試行

**期待結果**:
- URLが`/clinic/dashboard`に自動遷移
- ヘッダーにクリニック名「テストクリニックA」が表示される
- 左サイドメニューに以下のみ表示される:
  - ダッシュボード
  - 診療圏分析
  - レポート管理
  - 印刷物発注
  - 発注履歴
- 以下は表示されない:
  - 基礎データ管理
  - 経営シミュレーション
  - 医院設定
  - スタッフ管理
- 直接URLアクセス時、`/forbidden`ページへリダイレクト

**検証ポイント**:
- 権限別メニューフィルタリング
- 閲覧者権限の範囲（最も制限が厳しい）
- 直接URLアクセス時の権限チェック

---

### E2E-006: 旧URLからの自動リダイレクト

**目的**: 既存URLでアクセスした場合、新URL体系に自動リダイレクトされることを確認（後方互換性）

**前提条件**:
- clinic_ownerアカウント（owner@test.com）でログイン済み

**操作手順**:
1. ブラウザのアドレスバーに以下の旧URLを順次入力し、各遷移先を確認:
   - `/dashboard`
   - `/data-management`
   - `/market-analysis`
   - `/simulation`
   - `/reports`
   - `/clinic-settings`
   - `/staff-management`
   - `/print-order`
   - `/print-order-history`

**期待結果**:
- 各旧URLアクセス時、対応する新URLへ自動リダイレクト:
  - `/dashboard` → `/clinic/dashboard`
  - `/data-management` → `/clinic/data-management`
  - `/market-analysis` → `/clinic/market-analysis`
  - `/simulation` → `/clinic/simulation`
  - `/reports` → `/clinic/reports`
  - `/clinic-settings` → `/clinic/clinic-settings`
  - `/staff-management` → `/clinic/staff-management`
  - `/print-order` → `/clinic/print-order`
  - `/print-order-history` → `/clinic/print-order-history`
- リダイレクト後、ページ内容が正常に表示される
- ブラウザの「戻る」ボタンで無限ループに陥らない

**検証ポイント**:
- 後方互換性の確保
- リダイレクトロジックの正確性
- ユーザー体験の継続性

---

### E2E-007: 不正アクセス防止（認証チェック）

**目的**: 未ログイン状態で保護されたページにアクセスした場合、ログイン画面にリダイレクトされることを確認

**前提条件**:
- 未ログイン状態でテストを開始

**操作手順**:
1. ブラウザのアドレスバーに`/clinic/dashboard`を直接入力
2. 遷移先を確認
3. URLパラメータを確認
4. 正しいアカウント（owner@test.com）でログイン
5. 最初にアクセスしようとしたページに自動遷移することを確認

**期待結果**:
- `/login`ページへリダイレクト
- URLパラメータに`?redirect=/clinic/dashboard`が付与される
- ログインフォームが表示される
- ログイン成功後、`/clinic/dashboard`へ自動遷移
- 認証が必要である旨のメッセージが表示される（オプション）

**検証ポイント**:
- 認証チェックの動作
- リダイレクト元URLの保持
- ログイン後の自動遷移

---

### E2E-008: 不正アクセス防止（権限チェック）

**目的**: 権限不足のユーザーが管理者専用ページにアクセスした場合、403エラーページが表示されることを確認

**前提条件**:
- clinic_viewerアカウント（viewer@test.com）でログイン済み

**操作手順**:
1. ブラウザのアドレスバーに`/admin/dashboard`を直接入力
2. 遷移先を確認
3. エラーメッセージを確認
4. 「ダッシュボードに戻る」ボタンをクリック

**期待結果**:
- `/forbidden`ページへリダイレクト
- ページタイトルが「アクセス権限がありません」
- エラーメッセージ「このページへのアクセス権限がありません。」が表示される
- 「ダッシュボードに戻る」ボタンが表示される
- ボタンクリック時、`/clinic/dashboard`へ遷移
- HTTP 403ステータスコードがブラウザコンソールに記録される（確認推奨）

**検証ポイント**:
- 権限チェックの動作
- 適切なエラーページ表示
- ユーザーフレンドリーなエラーハンドリング

---

## 実施方法

### 手動テスト
1. 上記シナリオを順番に実施
2. 各テストケースごとに結果を記録（OK/NG）
3. NGの場合、スクリーンショット・エラーログを記録

### 自動テスト（将来対応）
- Playwright推奨
- テストコード配置: `tests/e2e/ui-structure-refactor.spec.ts`
- CI/CD統合: GitHub ActionsでPR時に自動実行

---

## 合格基準

- **全テストケース（8件）が正常動作すること**
- TypeScriptエラー: 0件
- ESLintエラー: 0件
- コンソールエラー（Critical）: 0件
- 警告は許容（但しログに記録）

---

## 備考

- **E2Eテストの範囲**: UIフロー・ルーティング・認証認可のみ
- **統合テストの範囲**: APIエラー（401/403/400/404）、バリデーションエラー
- **単体テストの範囲**: 個別コンポーネント、ユーティリティ関数

---

**作成日**: 2026-02-12
**バージョン**: 1.0
