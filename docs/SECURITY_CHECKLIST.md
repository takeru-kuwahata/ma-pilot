# MA-Pilot セキュリティチェックリスト

## 概要

このチェックリストは、MA-Pilotのセキュリティ対策が適切に実装されているかを確認するためのものです。

## デプロイ前チェックリスト

### データベース

- [ ] Supabase RLSが全テーブルで有効化されている
- [ ] `/supabase/rls_policies.sql`を実行済み
- [ ] 各テーブルのRLSポリシーが正しく動作している（テスト実施）
- [ ] security_audit_logsテーブルが作成されている
- [ ] データベース接続文字列が環境変数で管理されている
- [ ] 本番環境ではSupabase Service Keyを使用している

### 認証・認可

- [ ] Supabase Authが正しく設定されている
- [ ] JWTトークンの検証が実装されている（`/backend/src/middleware/auth.py`）
- [ ] すべてのAPIエンドポイントで認証チェックが実装されている
- [ ] ロールベースアクセス制御（RBAC）が実装されている
- [ ] 公開エンドポイント（/api/price-tables、/api/print-orders POST）のみ認証不要
- [ ] パスワードリセット機能が実装されている
- [ ] ログイン試行回数制限が実装されている（レート制限）

### バックエンドセキュリティ

- [ ] レート制限が設定されている（`/backend/src/middleware/rate_limit.py`）
- [ ] セキュリティヘッダーが設定されている（`/backend/main.py`）
- [ ] CORS設定が適切（許可されたオリジンのみ）
- [ ] TrustedHostMiddlewareが設定されている
- [ ] 本番環境ではHTTPSリダイレクトが有効
- [ ] APIドキュメント（/docs、/redoc）が本番環境では非公開
- [ ] 環境変数バリデーションが実装されている（`/backend/src/core/config.py`）
- [ ] SQL Injection対策（Supabase SDK使用、生SQL禁止）
- [ ] XSS対策（入力バリデーション、エスケープ）
- [ ] CSRF対策（トークンベース認証）

### フロントエンドセキュリティ

- [ ] 環境変数が適切に設定されている（`.env.local`）
- [ ] `.env`ファイルが`.gitignore`に追加されている
- [ ] センシティブデータがローカルストレージに保存されていない
- [ ] JWTトークンがHTTP-only Cookieに保存されている
- [ ] `dangerouslySetInnerHTML`の使用が最小限
- [ ] ユーザー入力のバリデーションが実装されている
- [ ] エラーメッセージに機密情報が含まれていない

### ロギング・監査

- [ ] セキュリティイベントがログ記録されている（`/backend/src/utils/logger.py`）
- [ ] ログイン/ログアウトが記録されている
- [ ] データアクセスが記録されている（重要なエンドポイント）
- [ ] 認証失敗が記録されている
- [ ] IPアドレス、ユーザーエージェントが記録されている
- [ ] ログの閲覧権限がシステム管理者のみに制限されている

### CI/CDセキュリティ

- [ ] GitHub Actionsでセキュリティスキャンが設定されている（`/.github/workflows/security.yml`）
- [ ] Bandit（Python）が実行されている
- [ ] npm audit（JavaScript）が実行されている
- [ ] CodeQLが実行されている
- [ ] GitGuardian（秘密情報漏洩スキャン）が設定されている
- [ ] Dependency Reviewが実行されている
- [ ] セキュリティスキャンが定期実行されている（週次）

### 依存関係管理

- [ ] `requirements.txt`に`slowapi`が追加されている
- [ ] `requirements.txt`に`bandit`が追加されている
- [ ] 依存関係に既知の脆弱性がない（`npm audit`、`pip-audit`）
- [ ] 依存関係が最新バージョン（セキュリティパッチ適用済み）

### 環境変数

- [ ] `.env.example`がサンプルとして提供されている
- [ ] `.env`ファイルが`.gitignore`に追加されている
- [ ] 本番環境の環境変数がVercel/Renderで設定されている
- [ ] APIキーが環境変数で管理されている（コード内にハードコーディングされていない）
- [ ] `SUPABASE_URL`がHTTPS必須でバリデーションされている
- [ ] `SUPABASE_KEY`の長さがバリデーションされている

### インフラストラクチャ

- [ ] 本番環境ではHTTPS必須
- [ ] TLS 1.2以上が使用されている
- [ ] ファイアウォールが適切に設定されている（必要なポートのみ開放）
- [ ] データベースへの直接アクセスが制限されている
- [ ] バックアップが定期的に取得されている
- [ ] バックアップデータが暗号化されている

### ドキュメント

- [ ] `SECURITY.md`が作成されている
- [ ] `SECURITY_CHECKLIST.md`が作成されている（このファイル）
- [ ] セキュリティポリシーが文書化されている
- [ ] インシデント対応フローが文書化されている
- [ ] 脆弱性報告方法が明記されている

## 機能別チェックリスト

### 認証機能

- [ ] ログインページでレート制限が実装されている
- [ ] パスワードの強度チェックが実装されている
- [ ] パスワードリセット機能が実装されている
- [ ] 2要素認証（将来実装予定）
- [ ] セッションタイムアウトが設定されている

### 月次データ管理

- [ ] 自医院データのみ閲覧可能（RLS）
- [ ] クリニック編集者以上のみ編集可能
- [ ] データ変更が監査ログに記録されている
- [ ] CSVインポート時のバリデーションが実装されている
- [ ] CSVインポート時のファイルサイズ制限がある

### シミュレーション機能

- [ ] 自医院データのみ閲覧可能（RLS）
- [ ] クリニック編集者以上のみ作成可能
- [ ] シミュレーション結果が適切に保存されている
- [ ] 不正なパラメータが入力された場合のエラーハンドリング

### レポート生成機能

- [ ] PDF生成時のレート制限が実装されている（5回/分）
- [ ] 自医院データのみアクセス可能（RLS）
- [ ] 生成されたPDFがSupabase Storageに安全に保存されている
- [ ] PDFダウンロードURLが期限付き（署名付きURL）

### 診療圏分析機能

- [ ] 外部APIへのリクエストがレート制限されている
- [ ] 自医院データのみアクセス可能（RLS）
- [ ] 外部API（e-Stat、RESAS、Google Maps）のAPIキーが環境変数で管理されている
- [ ] APIキーが公開されていない

### 管理機能

- [ ] システム管理者のみアクセス可能
- [ ] 医院アカウントの作成・削除が監査ログに記録されている
- [ ] ユーザーロール変更が監査ログに記録されている
- [ ] システム設定変更が監査ログに記録されている

### 印刷物受注システム

- [ ] 公開フォーム（/api/print-orders POST）が認証不要で動作
- [ ] レート制限が緩く設定されている（200回/分）
- [ ] 価格マスタ（price_tables）が全ユーザー閲覧可能
- [ ] 価格マスタの変更がシステム管理者のみ可能
- [ ] 注文データ（print_orders）のステータス変更がシステム管理者のみ可能

## テストチェックリスト

### セキュリティテスト

- [ ] 認証なしでの保護されたエンドポイントへのアクセスが拒否される
- [ ] 異なるクリニックのデータへのアクセスが拒否される
- [ ] ロール不足でのデータ編集が拒否される
- [ ] SQLインジェクション攻撃が防がれている
- [ ] XSS攻撃が防がれている
- [ ] CSRF攻撃が防がれている
- [ ] レート制限が正しく動作している

### RLSテスト

各テーブルで以下をテスト:
- [ ] clinicsテーブル: 自医院のみ閲覧、編集権限が正しい
- [ ] monthly_dataテーブル: 自医院のみ閲覧・編集
- [ ] simulationsテーブル: 自医院のみ閲覧・作成
- [ ] reportsテーブル: 自医院のみ閲覧・作成
- [ ] market_analysesテーブル: 自医院のみ閲覧・作成
- [ ] user_metadataテーブル: 自分自身と同クリニックユーザーのみ閲覧
- [ ] print_ordersテーブル: 全ユーザー閲覧・作成可能
- [ ] price_tablesテーブル: 全ユーザー閲覧可能、編集はシステム管理者のみ

### ペネトレーションテスト（将来実施）

- [ ] 外部セキュリティ専門家によるペネトレーションテスト
- [ ] 脆弱性診断レポートの作成
- [ ] 発見された脆弱性の修正

## 本番デプロイ前の最終確認

- [ ] すべての環境変数が本番環境で設定されている
- [ ] データベースRLSが有効化されている
- [ ] セキュリティヘッダーが正しく設定されている
- [ ] HTTPSが有効化されている
- [ ] APIドキュメントが非公開になっている
- [ ] ログ記録が正常に動作している
- [ ] セキュリティスキャンが全てパスしている
- [ ] バックアップが設定されている
- [ ] インシデント対応体制が整っている
- [ ] セキュリティドキュメントが最新

## 定期的な確認項目（月次）

- [ ] セキュリティスキャン結果の確認
- [ ] 依存関係の更新（セキュリティパッチ）
- [ ] 監査ログの確認（異常なアクセスがないか）
- [ ] バックアップの動作確認
- [ ] ユーザーアカウントの棚卸し（不要なアカウントの削除）
- [ ] RLSポリシーの見直し
- [ ] セキュリティドキュメントの更新

## インシデント発生時の対応

- [ ] インシデント対応チームへの連絡
- [ ] 影響範囲の特定
- [ ] 被害の最小化（アカウント無効化、アクセス遮断等）
- [ ] ログの保全
- [ ] 原因の特定と修正
- [ ] 影響を受けたユーザーへの通知
- [ ] 再発防止策の実施
- [ ] インシデントレポートの作成

## 備考

- このチェックリストは定期的に見直し、更新すること
- 新機能追加時は、セキュリティレビューを必須とすること
- セキュリティ上の問題を発見した場合は、即座に報告すること

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-12-26 | 1.0.0 | 初版作成 |
