# スタッフ管理・医院設定ページ 実装状況・連携設計

**最終更新**: 2026-02-04
**緊急度**: 🔴 高（フィールド名不一致でエラー発生中）

---

## 📊 実装状況サマリー

| ページ | 実装率 | 主な問題 |
|--------|--------|---------|
| スタッフ管理 | 70% | フィールド名不一致でclinic_id取得失敗 |
| 医院設定 | 40% | 保存処理未実装（TODOコメント） |

---

## 🐛 緊急問題: フィールド名の不一致

### 問題の原因

**バックエンド（Python）**: `clinic_id`（スネークケース）
**フロントエンド（TypeScript）**: `clinicId`（キャメルケース）

### 影響範囲

| ファイル | 使用フィールド | 動作状態 |
|---------|--------------|---------|
| Dashboard.tsx | `user?.clinic_id` | ✅ 正常 |
| **StaffManagement.tsx** | `user?.clinicId` | ❌ エラー |
| **DataManagement.tsx** | `user?.clinicId` | ❌ エラー |
| **Simulation.tsx** | `user?.clinicId` | ❌ エラー |
| その他多数 | `user?.clinicId` | ❌ エラー |

### エラーメッセージ

```
クリニック情報が見つかりません
```

### 修正方法（推奨）

**全フロントエンドページを `clinic_id` に統一**

```typescript
// 修正前（エラー）
const clinicId = user?.clinicId;

// 修正後（正常）
const clinicId = user?.clinic_id;
```

**工数**: 2時間

---

## 📋 スタッフ管理ページ実装状況

### 実装済み（70%）

| 機能 | 実装状態 |
|------|---------|
| スタッフ一覧表示 | ✅ 完了 |
| データ取得処理 | ✅ 完了 |
| 権限表示（Chip） | ✅ 完了 |
| スタッフ削除機能 | ✅ 完了 |
| エラーハンドリング | ✅ 完了 |
| ローディング状態 | ✅ 完了 |

### 未実装（30%）

| 機能 | 実装状態 | 備考 |
|------|---------|------|
| スタッフ招待機能 | ❌ TODO | alert('招待機能は現在開発中です') |
| スタッフ編集機能 | ❌ TODO | alert('スタッフ編集機能は現在開発中です') |

### バックエンドAPI（✅ 完全実装済み）

| エンドポイント | メソッド | 実装状態 |
|-------------|---------|---------|
| `/api/staff` | GET | ✅ 完了 |
| `/api/staff/invite` | POST | ✅ 完了 |
| `/api/staff/{user_id}/role` | PUT | ✅ 完了 |
| `/api/staff/{user_id}` | DELETE | ✅ 完了 |

---

## 📋 医院設定ページ実装状況

### 実装済み（40%）

| 機能 | 実装状態 |
|------|---------|
| 基本情報フォーム | ✅ 完了 |
| 経営情報フォーム | ✅ 完了 |
| UI完成 | ✅ 完了 |

### 未実装（60%）

| 機能 | 実装状態 | 備考 |
|------|---------|------|
| 保存処理 | ❌ TODO | handleSaveBasicInfo() が空 |
| データ取得処理 | ❌ TODO | 初期値がハードコード |
| API連携 | ❌ TODO | clinicService.updateClinic() 未呼び出し |
| バリデーション | ❌ TODO | 未実装 |

### バックエンドAPI（✅ 完全実装済み）

| エンドポイント | メソッド | 実装状態 |
|-------------|---------|---------|
| `/api/clinics/{clinic_id}` | GET | ✅ 完了 |
| `/api/clinics/{clinic_id}` | PUT | ✅ 完了 |

---

## 🎯 2ページ連携設計

### 結論: **独立して動作可能**

医院設定とスタッフ管理は**データ的に独立**しているため、特別な連携制約は不要。

**理由**:
1. `user_metadata.clinic_id` は既にログイン時に設定済み
2. 医院設定の保存有無に関わらず、`clinic_id` は取得可能
3. スタッフ管理は `clinic_id` さえあれば動作する

### データフロー

```
[ログイン]
  ↓
[user_metadata.clinic_id 取得]
  ↓
[医院設定ページ] ← clinic_id で既存データ取得・更新
  ↓
[スタッフ管理ページ] ← clinic_id でスタッフ一覧取得
```

---

## 🚀 実装計画（クライアント打ち合わせ用）

### Phase 1: 緊急修正（🔴 最優先）

| タスク | 工数 | 優先度 |
|--------|------|--------|
| フィールド名の統一（clinic_id） | 2時間 | 🔴 最優先 |
| 医院設定保存処理実装 | 3時間 | 🔴 高 |
| **Phase 1 合計** | **5時間** | - |

### Phase 2: 機能完成

| タスク | 工数 | 優先度 |
|--------|------|--------|
| スタッフ招待機能実装 | 4時間 | 🟡 中 |
| スタッフ編集機能実装 | 3時間 | 🟡 中 |
| 医院設定データ取得 | 2時間 | 🟢 低 |
| **Phase 2 合計** | **9時間** | - |

### 総工数

**合計**: 14時間（約2日）

---

## 📝 クライアント協議事項

### 質問1: 緊急修正の実施タイミング

- **オプションA**: 打ち合わせ後すぐに実施（5時間 → 今日中に完了）
- **オプションB**: 明日以降に実施

### 質問2: Phase 2の実施優先度

- **スタッフ招待機能**: 本番運用で必要か？
- **スタッフ編集機能**: 権限変更は頻繁に行うか？

### 質問3: 暫定運用の可否

**フィールド名統一のみ実施**して、以下は暫定運用:
- 医院設定: 管理者がDB直接更新
- スタッフ招待: メール手動送信

---

## 検証結果（チェックリスト）

### 4.1 医院設定

| # | 項目 | 結果 | 備考 |
|---|------|------|------|
| 4.1.1 | ページ表示 | ✅ | UI完成 |
| 4.1.2 | 基本情報表示 | ✅ | デフォルト値表示 |
| 4.1.3 | 経営情報表示 | ✅ | デフォルト値表示 |
| 4.1.4 | データ読み込み | ❌ | 未実装 |
| 4.1.5 | 基本情報保存 | ❌ | 未実装（TODO） |
| 4.1.6 | 経営情報保存 | ❌ | 未実装（TODO） |

### 4.2 スタッフ管理

| # | 項目 | 結果 | 備考 |
|---|------|------|------|
| 4.2.1 | ページ表示 | ❌ | フィールド名不一致でエラー |
| 4.2.2 | スタッフ一覧表示 | ❌ | clinic_id取得失敗 |
| 4.2.3 | スタッフ招待 | ❌ | 未実装（alert） |
| 4.2.4 | スタッフ編集 | ❌ | 未実装（alert） |
| 4.2.5 | スタッフ削除 | ⚠️ | 実装済みだがテスト不可 |

---

## 🔴 打ち合わせでの推奨提案

### 提案1: 緊急修正を最優先実施

**今日中に**: フィールド名統一（2時間） → スタッフ管理・データ管理が動作可能に

### 提案2: 医院設定保存は暫定運用

**暫定**: 管理者がDB直接更新
**本番前**: 保存処理実装（3時間）

### 提案3: Phase 2は本番運用開始後に実装

スタッフ招待・編集は運用しながら必要性を判断
